
test-network 분석

https://github.com/hyperledger/fabric-samples/tree/main/test-network

## 실행 명령어

Fabric CA를 사용
```
./network.up -ca
```

## 로그 기반 실행 순서
. Creating ca_org1, ca_org2, ca_orderer
. Creating Org1 Identities

[cols="1,1"]
|===
|구분|명령어

|Enrolling the CA Admin
|fabric-ca-client enroll -u https://admin:adminpw@localhost:7054 --caname ca-org1 --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Registering peer0
|fabric-ca-client register --caname ca-org1 --id.name peer0 --id.secret peer0pw --id.type peer --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Registering user
|fabric-ca-client register --caname ca-org1 --id.name user1 --id.secret user1pw --id.type client --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Registering the org admin
|fabric-ca-client register --caname ca-org1 --id.name org1admin --id.secret org1adminpw --id.type admin --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Generating the peer0 msp
|fabric-ca-client enroll -u https://peer0:peer0pw@localhost:7054 --caname ca-org1 -M ./organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp --csr.hosts peer0.org1.example.com --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Generating the peer0-tls certificates
|fabric-ca-client enroll -u https://peer0:peer0pw@localhost:7054 --caname ca-org1 -M ./organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls --enrollment.profile tls --csr.hosts peer0.org1.example.com --csr.hosts localhost --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Generating the user msp
|fabric-ca-client enroll -u https://user1:user1pw@localhost:7054 --caname ca-org1 -M ./organizations/peerOrganizations/org1.example.com/users/User1@org1.example.com/msp --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Generating the org admin msp
|fabric-ca-client enroll -u https://org1admin:org1adminpw@localhost:7054 --caname ca-org1 -M ./organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|===

[start=3]
. Creating Org2 Identities
. Creating Orderer Identities

[cols="1,1"]
|===
|구분|명령어

|Enrolling the CA admin
|fabric-ca-client enroll -u https://admin:adminpw@localhost:9054 --caname ca-orderer --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|Registering orderer
|fabric-ca-client register --caname ca-orderer --id.name orderer --id.secret ordererpw --id.type orderer --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|Registering the orderer admin
|fabric-ca-client register --caname ca-orderer --id.name ordererAdmin --id.secret ordererAdminpw --id.type admin --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|Generating the orderer msp
|fabric-ca-client enroll -u https://orderer:ordererpw@localhost:9054 --caname ca-orderer -M ./organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp --csr.hosts orderer.example.com --csr.hosts localhost --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|Generating the orderer-tls certificates
|fabric-ca-client enroll -u https://orderer:ordererpw@localhost:9054 --caname ca-orderer -M ./organizations/ordererOrganizations/example.com/orderers/orderer.example.com/tls --enrollment.profile tls --csr.hosts orderer.example.com --csr.hosts localhost --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|Generating the admin msp
|fabric-ca-client enroll -u https://ordererAdmin:ordererAdminpw@localhost:9054 --caname ca-orderer -M ./organizations/ordererOrganizations/example.com/users/Admin@example.com/msp --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|===

[start=6]
. Generating CCP files for Org1 and Org2
.. Creating volume "compose_orderer.example.com"
.. Creating volume "compose_peer0.org1.example.com"
.. Creating volume "compose_peer0.org2.example.com"
.. Creating peer0.org2.example.com
.. Creating peer0.org1.example.com
.. Creating orderer.example.com
.. Creating cli

ccp(common connection profile): application에서 gateway를 설정하여 network 와의 통신을 관리하는 데 사용됩니다.


## 코드 분석

### ./network up -ca

변수들에 설정들이 기본 값들이 정의되고 '-ca' 옵션에 의해서 'CRYPTO' 값은 "Certificate Authorities"로 변경된다.
$MODE 값 "up"에 의해서 networkUp() 함수가 호출된다.

```
ROOTDIR=$(cd "$(dirname "$0")" && pwd)
export PATH=${ROOTDIR}/../bin:${PWD}/../bin:$PATH
export FABRIC_CFG_PATH=${PWD}/configtx
export VERBOSE=false
...
CHANNEL_NAME="mychannel"
COMPOSE_FILE_BASE=compose-test-net.yaml
COMPOSE_FILE_COUCH=compose-couch.yaml
COMPOSE_FILE_CA=compose-ca.yaml
DATABASE="leveldb"

...
## Parse mode
if [[ $# -lt 1 ]] ; then
  printHelp
  exit 0
else
  MODE=$1
  shift
fi

...

while [[ $# -ge 1 ]] ; do
  key="$1"
  case $key in
  ...
  -ca )
    CRYPTO="Certificate Authorities"
    ;;
  ...
esac
  shift
done

# Are we generating crypto material with this command?
if [ ! -d "organizations/peerOrganizations" ]; then
  CRYPTO_MODE="with crypto from '${CRYPTO}'"
else
  CRYPTO_MODE=""
fi

# Determine mode of operation and printing out what we asked for
if [ "$MODE" == "up" ]; then
  infoln "Starting nodes with CLI timeout of '${MAX_RETRY}' tries and CLI delay of '${CLI_DELAY}' seconds and using database '${DATABASE}' ${CRYPTO_MODE}"
  networkUp
elif [ "$MODE" == "createChannel" ]; then
  infoln "Creating channel '${CHANNEL_NAME}'."
  infoln "If network is not up, starting nodes with CLI timeout of '${MAX_RETRY}' tries and CLI delay of '${CLI_DELAY}' seconds and using database '${DATABASE} ${CRYPTO_MODE}"
  createChannel
elif [ "$MODE" == "down" ]; then
  infoln "Stopping network"
  networkDown
elif [ "$MODE" == "restart" ]; then
  infoln "Restarting network"
  networkDown
  networkUp
elif [ "$MODE" == "deployCC" ]; then
  infoln "deploying chaincode on channel '${CHANNEL_NAME}'"
  deployCC
elif [ "$MODE" == "deployCCAAS" ]; then
  infoln "deploying chaincode-as-a-service on channel '${CHANNEL_NAME}'"
  deployCCAAS
else
  printHelp
  exit 1
fi
```

### networkUp()

먼저 checkPrereqs() 함수를 실행하여 fabric binaries/image 의 버전을 확인합니다. +
이후 createOrgs()를 통해 조직별 CA를 구동하고 조직별 crypto material을 생성합니다. +
마지막으로 docker-compose를 이용해서 container를 실행합니다.

link:https://github.com/hyperledger/fabric-samples/blob/main/test-network/compose/compose-test-net.yaml[compose/compose-test-net.yaml] +
link:https://github.com/hyperledger/fabric-samples/blob/main/test-network/compose/docker/docker-compose-test-net.yaml[compose/docker/docker-compose-test-net.yaml]


```
function networkUp() {
  checkPrereqs

  # generate artifacts if they don't exist
  if [ ! -d "organizations/peerOrganizations" ]; then
    createOrgs
  fi

  COMPOSE_FILES="-f compose/${COMPOSE_FILE_BASE} -f compose/${CONTAINER_CLI}/${CONTAINER_CLI}-${COMPOSE_FILE_BASE}"
  # COMPOSE_FILES="-f compose/compose-test-net.yaml -f compose/docker/docker-compose-test-net.yaml"
  
  if [ "${DATABASE}" == "couchdb" ]; then
    COMPOSE_FILES="${COMPOSE_FILES} -f compose/${COMPOSE_FILE_COUCH} -f compose/${CONTAINER_CLI}/${CONTAINER_CLI}-${COMPOSE_FILE_COUCH}"
    # COMPOSE_FILES="${COMPOSE_FILES} -f compose/compose-couch.yaml -f compose/docker/docker-compose-couch.yaml"
  fi

  DOCKER_SOCK="${DOCKER_SOCK}" ${CONTAINER_CLI_COMPOSE} ${COMPOSE_FILES} up -d 2>&1
  
  $CONTAINER_CLI ps -a
  if [ $? -ne 0 ]; then
    fatalln "Unable to start network"
  fi
}
```



#### createOrgs()
Fabric-CA 를 통해서 Identities 를 생성합니다. +
우선 ca-org1, ca-org2, ca-orderer container를 실행합니다. 이후 'organizations/fabric-ca/registerEnroll.sh'의 createOrg1(), createOrg2() createOrderer() 함수를 실행하여 각 기관의 crypto material을 생성합니다.
이후, 'organizations/ccp-generate.sh'를 실행하여 Org1과 Org2의 CCP 파일을 생성합니다.

link:https://github.com/hyperledger/fabric-samples/blob/main/test-network/compose/compose-ca.yaml[compose/compose-ca.yaml] +
link:https://github.com/hyperledger/fabric-samples/blob/main/test-network/compose/docker/docker-compose-ca.yaml[compose/docker/docker-compose-ca.yaml]

```
function createOrgs() {
  if [ -d "organizations/peerOrganizations" ]; then
    rm -Rf organizations/peerOrganizations && rm -Rf organizations/ordererOrganizations
  fi

  # Create crypto material using cryptogen

  # Create crypto material using Fabric CA
  if [ "$CRYPTO" == "Certificate Authorities" ]; then
    infoln "Generating certificates using Fabric CA"
    ${CONTAINER_CLI_COMPOSE} -f compose/$COMPOSE_FILE_CA -f compose/$CONTAINER_CLI/${CONTAINER_CLI}-$COMPOSE_FILE_CA up -d 2>&1
    # docker-compose -f compose/compose-ca.yaml -f compose/docker/docker-compose-ca.yml up -d 2>&1

    . organizations/fabric-ca/registerEnroll.sh  # include createOrg1(), createOrg2(), createOrderer()

    while :
    do
      if [ ! -f "organizations/fabric-ca/org1/tls-cert.pem" ]; then
        sleep 1
      else
        break
      fi
    done

    infoln "Creating Org1 Identities"

    createOrg1

    infoln "Creating Org2 Identities"

    createOrg2

    infoln "Creating Orderer Org Identities"

    createOrderer

  fi

  infoln "Generating CCP files for Org1 and Org2"
  ./organizations/ccp-generate.sh
```

#### createOrgs() createOrg1()

Org1에 대한 crypto material 작업을 진행합니다.

[cols="1,1"]
|===
|구분|명령어

|Enrolling the CA Admin
|fabric-ca-client enroll -u https://admin:adminpw@localhost:7054 --caname ca-org1 --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Registering peer0
|fabric-ca-client register --caname ca-org1 --id.name peer0 --id.secret peer0pw --id.type peer --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Registering user
|fabric-ca-client register --caname ca-org1 --id.name user1 --id.secret user1pw --id.type client --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Registering the org admin
|fabric-ca-client register --caname ca-org1 --id.name org1admin --id.secret org1adminpw --id.type admin --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Generating the peer0 msp
|fabric-ca-client enroll -u https://peer0:peer0pw@localhost:7054 --caname ca-org1 -M ./organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp --csr.hosts peer0.org1.example.com --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Generating the peer0-tls certificates
|fabric-ca-client enroll -u https://peer0:peer0pw@localhost:7054 --caname ca-org1 -M ./organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls --enrollment.profile tls --csr.hosts peer0.org1.example.com --csr.hosts localhost --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Generating the user msp
|fabric-ca-client enroll -u https://user1:user1pw@localhost:7054 --caname ca-org1 -M ./organizations/peerOrganizations/org1.example.com/users/User1@org1.example.com/msp --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|Generating the org admin msp
|fabric-ca-client enroll -u https://org1admin:org1adminpw@localhost:7054 --caname ca-org1 -M ./organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp --tls.certfiles ./organizations/fabric-ca/org1/ca-cert.pem

|===

createOrg2()는 createOrg1()과거의 동일한 작업을 진행합니다.

#### createOrgs() createOrderer()

Orderer에 대한 crypto material 작업을 진행합니다.

[cols="1,1"]
|===
|구분|명령어

|Enrolling the CA admin
|fabric-ca-client enroll -u https://admin:adminpw@localhost:9054 --caname ca-orderer --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|Registering orderer
|fabric-ca-client register --caname ca-orderer --id.name orderer --id.secret ordererpw --id.type orderer --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|Registering the orderer admin
|fabric-ca-client register --caname ca-orderer --id.name ordererAdmin --id.secret ordererAdminpw --id.type admin --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|Generating the orderer msp
|fabric-ca-client enroll -u https://orderer:ordererpw@localhost:9054 --caname ca-orderer -M ./organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp --csr.hosts orderer.example.com --csr.hosts localhost --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|Generating the orderer-tls certificates
|fabric-ca-client enroll -u https://orderer:ordererpw@localhost:9054 --caname ca-orderer -M ./organizations/ordererOrganizations/example.com/orderers/orderer.example.com/tls --enrollment.profile tls --csr.hosts orderer.example.com --csr.hosts localhost --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|Generating the admin msp
|fabric-ca-client enroll -u https://ordererAdmin:ordererAdminpw@localhost:9054 --caname ca-orderer -M ./organizations/ordererOrganizations/example.com/users/Admin@example.com/msp --tls.certfiles ./organizations/fabric-ca/ordererOrg/ca-cert.pem

|===

#### createOrgs() ccp-generate.sh

Org1과 Org2의 CCP 파일을 생성합니다. +
CCP 파일은 ./organizations/cp-template.{json|yaml} 파일을 템플릿으로 하여 생성됩니다. +
생성된 파일은 './organiazations/peerOrganizations/{organizationDoamin}/connection-{organization}.{json|yaml}' 에 저장됩니다.

```
#!/bin/bash

function one_line_pem {
    echo "`awk 'NF {sub(/\\n/, ""); printf "%s\\\\\\\n",$0;}' $1`"
}

function json_ccp {
    local PP=$(one_line_pem $4)
    local CP=$(one_line_pem $5)
    sed -e "s/\${ORG}/$1/" \
        -e "s/\${P0PORT}/$2/" \
        -e "s/\${CAPORT}/$3/" \
        -e "s#\${PEERPEM}#$PP#" \
        -e "s#\${CAPEM}#$CP#" \
        organizations/ccp-template.json
}

function yaml_ccp {
    local PP=$(one_line_pem $4)
    local CP=$(one_line_pem $5)
    sed -e "s/\${ORG}/$1/" \
        -e "s/\${P0PORT}/$2/" \
        -e "s/\${CAPORT}/$3/" \
        -e "s#\${PEERPEM}#$PP#" \
        -e "s#\${CAPEM}#$CP#" \
        organizations/ccp-template.yaml | sed -e $'s/\\\\n/\\\n          /g'
}

ORG=1
P0PORT=7051
CAPORT=7054
PEERPEM=organizations/peerOrganizations/org1.example.com/tlsca/tlsca.org1.example.com-cert.pem
CAPEM=organizations/peerOrganizations/org1.example.com/ca/ca.org1.example.com-cert.pem

echo "$(json_ccp $ORG $P0PORT $CAPORT $PEERPEM $CAPEM)" > organizations/peerOrganizations/org1.example.com/connection-org1.json
echo "$(yaml_ccp $ORG $P0PORT $CAPORT $PEERPEM $CAPEM)" > organizations/peerOrganizations/org1.example.com/connection-org1.yaml

ORG=2
P0PORT=9051
CAPORT=8054
PEERPEM=organizations/peerOrganizations/org2.example.com/tlsca/tlsca.org2.example.com-cert.pem
CAPEM=organizations/peerOrganizations/org2.example.com/ca/ca.org2.example.com-cert.pem

echo "$(json_ccp $ORG $P0PORT $CAPORT $PEERPEM $CAPEM)" > organizations/peerOrganizations/org2.example.com/connection-org2.json
echo "$(yaml_ccp $ORG $P0PORT $CAPORT $PEERPEM $CAPEM)" > organizations/peerOrganizations/org2.example.com/connection-org2.yaml
```



## Reference
* link:https://medium.com/@taehyoung46/fabric-samples-network-sh-%EB%B6%84%EC%84%9D-a845ce2f71db[Fabric-samples network.sh 분석]
