
Hyperledeger Fabric v2.4 Custom Network 구성

* Docker Compose 사용 (Docker Compose 성공하면 k8s로 변경하여 수정 예정)
* Fabric CA 사용
* LevelDB 사용 (LevelDB 성공하면 CouchDB로 변경하여 수정 예정)

## 네트워크 구성 요소
* Orderer 1개
* Organization 2개
* Organization 별 Peer 1개
* Organization 별 Admin 1명, User 1명
* Organization 별 Cli 1개
* Channel 1개 - 모든 Orderer 및 Peer 가입(Join)

## 네트워크 구성 순서

* 조직별 CA 생성 및 Contrainer 실행
* 조직별 Identity 생성
* Peer를 포함하는 조직의 CCP 생성
* Container 실행 (Orderer, Peer, Cli)
* configtxgen을 이용하여 채널 genesis block 생성(Configuration Block) /w configtx.yaml
* osnadmin을 이용하여 채널 생성 및 Orderer 채널 가입 /w 채널 genesis block
* 각 조직의 Peer들을 채널에 가입(Join)
* 각 조직의 AnchorPeer 설정

### 조직별 CA 생성 및 Contrainer 실행

1. 조직별 CA 설정파일 작성 - link:https://github.com/hyperledger/fabric-samples/blob/main/test-network/organizations/fabric-ca/org1/fabric-ca-server-config.yaml[Org1], link:https://github.com/hyperledger/fabric-samples/blob/main/test-network/organizations/fabric-ca/ordererOrg/fabric-ca-server-config.yaml[Orderer]
2. 'docker-compose-ca.yaml' CA Docker Compose 설정파일 작성 - link:https://github.com/hyperledger/fabric-samples/blob/main/test-network/compose/compose-ca.yaml[test-network compose-ca.yaml]
3. cotainer 배포 +
docker-compose -f compose-ca.yaml up -d 2>&1
4. ca Identity 파일 확인 (./organizations/fabric-ca/{organizationName})
```
./
├── IssuerPublicKey
├── IssuerRevocationPublicKey
├── ca-cert.pem
├── fabric-ca-server-config.yaml
├── fabric-ca-server.db
├── msp
│   ├── cacerts
│   ├── keystore
│   │   ├── 84cb92646b3b7a74bd77f8727aa5b3871e7a6aaf34a2949a3d6ab77badb551d0_sk
│   │   ├── IssuerRevocationPrivateKey
│   │   ├── IssuerSecretKey
│   │   └── a11b524715aec040c0b352efcc4dfc939e9850ff1e40532f766a5bf3aca665a6_sk
│   ├── signcerts
│   └── user
└── tls-cert.pem
```

**참고: 2>&1** - link:https://reebok.tistory.com/56[/dev/null 2>&1 의 의미]

n >&m: 표준출력과 표준에러를 서로 바꾸기. +
0, 1, 2는 각각 표준입력, 표준출력, 그리고 표준에러를 의미합니다. 

2>&1의 의미는 표준 출력의 전달되는 곳으로 표준에러를 전달하라라는 의미입니다. 

### 조직별 Identity 생성

link:https://hyperledger-fabric-ca.readthedocs.io/en/release-1.4/deployguide/use_CA.html#folder-structure-for-your-org-and-node-admin-identities[Folder structure for your org and node admin identities]

image:https://hyperledger-fabric-ca.readthedocs.io/en/release-1.4/_images/organizationswithpeer.png[]

#### Peer 조직

. fabric-ca-clinet enroll 이용하여 CA admin 등록(enroll)
. 기본 설정 파일(fabric-ca-client-config.yaml) 수정 (CA Admin enroll시 생성)
. fabric-ca-clinet register 이용하여 Peer 'peer0' 등록(register)
. fabric-ca-clinet register 이용하여 User 'user' 등록(register)
. fabric-ca-clinet register 이용하여 User 'org admin' 등록(register)
. fabric-ca-clinet enroll 이용하여 Peer 'peer0' msp 생성
. fabric-ca-clinet enroll 이용하여 Peer 'peer0-tls' certificates 생성
. fabric-ca-clinet enroll 이용하여 User 'user' msp 생성
. fabric-ca-clinet enroll 이용하여 User 'org admin' msp 생성


#### Orderer 조직

. fabric-ca-clinet enroll 이용하여 CA admin 등록(enroll)
. 기본 설정 파일(fabric-ca-client-config.yaml) 수정 (CA Admin enroll시 생성)
. fabric-ca-clinet register 이용하여 Orderer 'orderer' 등록(register)
. fabric-ca-clinet register 이용하여 Admin 'ordererAdmin' 등록(register)
. fabric-ca-clinet enroll 이용하여 Orderer 'orderer' msp 생성
. fabric-ca-clinet enroll 이용하여 Orderer 'orderer-tls' certificates 생성
. fabric-ca-clinet enroll 이용하여 Admin 'ordererAdmin' msp 생성

### Peer를 포함하는 조직의 CCP 생성

link:https://github.com/hyperledger/fabric-samples/blob/main/test-network/organizations/ccp-template.yaml[ccp-template.yaml], link:https://github.com/hyperledger/fabric-samples/blob/main/test-network/organizations/ccp-generate.sh[ccp-generate.sh]

/organizations/ccp-template.yaml 및 /organizations/ccp-template.sh를 참고하여,
Peer를 포함하는 조직의 CCP 파일 생성

조직별로 아래 파일들이 생성되어야 합니다.

/organizations/peerOrganizations/{organization}.{domain}/connection-{organization}.yaml

예) domain: moss.com, organization: service1 +
/organizations/peerOrganizations/service1.moss.com/connection-service1.yaml

ccp(common connection profile): application에서 gateway를 설정하여 network 와의 통신을 관리하는 데 사용됩니다.

### Container 실행 (Orderer, Peer, Cli)
. 'compose-network.yaml' 네트워크 Docker Compose 설정파일 작성, 참고: link:https://github.com/hyperledger/fabric-samples/blob/main/test-network/compose/compose-test-net.yaml[compose-test-net.yaml] +
test-network와 다르게 Peer Organization 별 Cli를 1개씩 정의 했으므로 Cli Container가 한개 더 추가된다.
. cotainer 배포 +
docker-compose -f compose-network.yaml up -d 2>&1
. container 정상 동작 확인 : orderer 1개, peer 2개, cli 2개 (앞에서 실행한 ca3 개를 포함하여 총 8개) +
docker container ls

조금 더 발전된 형태는 인증서 파일들을 mount 하는 것이 아닌 파일들을 복사한 새로운 이미지를 만들어서 배포하는 것일 것이다. k8s를 이용하면 PV를 이용하여 인증서를 공유하고 mount하여 처리 하는 것도 고려해 볼 수 있다.

### configtxgen을 이용하여 채널 genesis block 생성(Configuration Block) /w configtx.yaml

. 채널명 환경변수 설정 : CHANNEL_NAME="mosschannel"
. ./../config/configtx.yaml 채널 설정 파일을 작성한다. 참고: link:https://github.com/hyperledger/fabric-samples/blob/main/test-network/configtx/configtx.yaml[configtx.yaml]
. 환경변수 설정 - FABRIC_CFG_PATH=${PWD}/configtx
. block 생성 +
configtxgen -profile TwoOrgsApplicationGenesis -outputBlock ./channel-artifacts/${CHANNEL_NAME}.block -channelID $CHANNEL_NAME
. 환경변수 경로 재설정 - FABRIC_CFG_PATH=$PWD/../config/
. 채널 genesis block 경로 환경변수 설정 - BLOCKFILE="./channel-artifacts/${CHANNEL_NAME}.block"

### osnadmin을 이용하여 채널 생성 및 Orderer 채널 가입 /w 채널 genesis block

. $FABRIC_CFG_PATH/orderer.yaml Orderer 설정파일 수정
. osnadmin channel join 를 이용하여 채널 genesis block으로 채널 생성(존재하지 않으면 생성) 및 Orderer를 채널에 가입 +
osnadmin channel join --channelID $CHANNEL_NAME --config-block ./channel-artifacts/${CHANNEL_NAME}.block -o localhost:7053 --ca-file "$ORDERER_CA" --client-cert "$ORDERER_ADMIN_TLS_SIGN_CERT" --client-key "$ORDERER_ADMIN_TLS_PRIVATE_KEY" + 
osnadmin channel join --channelID mychannel --config-block ./channel-artifacts/mychannel.block -o localhost:7053 --ca-file ./ordererOrganizations/example.com/tlsca/tlsca.example.com-cert.pem --client-cert ./organizations/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.crt --client-key ./organizations/ordererOrganizations/example.com/orderers/orderer.example.com/tls/server.key

### 각 조직의 Peer들을 채널에 가입(Join)

. peer channel join 명령어 실행을 위한 환경변수 설정
.. export CORE_PEER_LOCALMSPID="Org1MSP"
.. export CORE_PEER_TLS_ROOTCERT_FILE=$PEER0_ORG1_CA
.. export CORE_PEER_MSPCONFIGPATH=${PWD}/organizations/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
.. export CORE_PEER_ADDRESS=localhost:7051
.. 추가환경설정 변수 확인 필요
. peer channel join 명령어로 Peer의 채널 가입(join) - peer channel join -b $BLOCKFILE >&log.txt


### 각 조직의 AnchorPeer 설정
cli container에서 실행되어야 한다.

. 채널 config를 조회
. anchor peer에 추가를 위한 설정 수정
. 현재 설정과 수정된 설정의 diff로 config update tx(Org1MSPconfig.json) 생성
. AnchorPeer 수정

```
# 채널 config 조회
setGlobals 1
peer channel fetch config config_block.pb -o orderer.exmaple.com:7050 --ordererTLSHostnameOverride orderer.example.com -c mychannel --tls --cafile "./organizations/ordererOrganizations/example.com/tlsca/tlsca.example.com-cert.pem"
configtxlator proto_decode --input config_block.pb --type common.Block --output config_block.json
jq .data.data[0].payload.data.config config_block.json >"Org1MSPconfig.json"

# anchor peer에 추가를 위한 설정 수정
jq '.channel_group.groups.Application.groups.'Org1MSP}'.values += {"AnchorPeers":{"mod_policy": "Admins","value":{"anchor_peers": [{"host": "'peer0.org1.example.com'","port": '7051'}]},"version": "0"}}' Org1MSPconfig.json > Org1MSPmodified_config.json

# 현재 설정과 수정된 설정의 diff로 config update tx(Org1MSPconfig.json) 생성
configtxlator proto_encode --input "Org1MSPconfig.json" --type common.Config --output original_config.pb
configtxlator proto_encode --input "Org1MSPmodified_config.json" --type common.Config --output modified_config.pb
configtxlator compute_update --channel_id "mychannel" --original original_config.pb --updated modified_config.pb --output config_update.pb
configtxlator proto_decode --input config_update.pb --type common.ConfigUpdate --output config_update.json
echo '{"payload":{"header":{"channel_header":{"channel_id":"'mychannel'", "type":2}},"data":{"config_update":'$(cat config_update.json)'}}}' | jq . >config_update_in_envelope.json
configtxlator proto_encode --input config_update_in_envelope.json --type common.Envelope --output "Org1MSPanchors.tx"

# AnchorPeer 수정
peer channel update -o orderer.example.com:7050 --ordererTLSHostnameOverride orderer.example.com -c mychannel -f Org1MSPanchors.tx --tls --cafile "./organizations/ordererOrganizations/example.com/tlsca/tlsca.example.com-cert.pem" >&log.txt
```

## Custom Network Configuration
실제 Custom 네트워크 설정을 해본다. +
진행 환경은 'ubuntu 20.04' 또는 'wsl2(ubuntu 20.04) on windows 10' 에서 진행합니다. +
컨테이너 환경은 docker, docker-compose를 이용합니다.

* domain: moss.com
* channel : mosschannel
** ordererOrganizations: oderer1
** peerOrganizations: platform, customer, service1, service2
** policy: test-network default policy
* organizations
** orderer1
*** domain: orderer1.moss.com
*** users
**** admin
*** orderer node: 3개
**** osn1.orderer1.moss.com
**** osn2.orderer1.moss.com
**** osn3.orderer1.moss.com
** platform organization
*** domain: platform.moss.com
*** users
**** admin
**** user1
*** peer node: 2개
**** peer0.platform.moss.com (anchor peer)
**** peer1.platform.moss.com
** customer organization
*** domain: customer.moss.com
*** users
**** admin
**** user1
*** peer node: 2개
**** peer0.customer.moss.com (anchor peer)
**** peer1.customer.moss.com
** service1 organization
*** domain: service1.moss.com
*** users
**** admin
**** user1
*** peer node: 2개
**** peer0.service1.moss.com (anchor peer)
**** peer1.service1.moss.com
** service2 organization
*** domain: service2.moss.com
*** users
**** admin
**** user1
*** peer node: 2개
**** peer0.service2.moss.com (anchor peer)
**** peer1.service2.moss.com

### 바이너리 다운로드

moss-network 또는 임의의 폴더 생성 후, fabric, fabric-ca linux 바이너리를 다운받아서 압축을 풉니다. 이후 ./bin을 PATH 경로에 추가합니다.

진행의 편의를 위해서 moss-network 폴더 경로를 'FABRIC_NETWORK_HOME' 환경변수로 설정합니다.

* link:https://github.com/hyperledger/fabric/releases/tag/v2.4.2[fabric v2.4.2]
* link:https://github.com/hyperledger/fabric-ca/releases/tag/v1.5.2[fabric-ca v1.5.2]

```
mkdir moss-network
cd moss-network
export FABRIC_NETWORK_HOME=${PWD}

curl -L https://github.com/hyperledger/fabric/releases/download/v2.4.2/hyperledger-fabric-linux-amd64-2.4.2.tar.gz -o hyperledger-fabric-linux-amd64-2.4.2.tar.gz
curl -L https://github.com/hyperledger/fabric-ca/releases/download/v1.5.2/hyperledger-fabric-ca-linux-amd64-1.5.2.tar.gz -o hyperledger-fabric-ca-linux-amd64-1.5.2.tar.gz

sudo tar -zxvf hyperledger-fabric-linux-amd64-2.4.2.tar.gz
sudo tar -zxvf hyperledger-fabric-ca-linux-amd64-1.5.2.tar.gz

export PATH=${PWD}/bin:$PATH

```

작업 완료 후
```
/moss-network
├── bin
│   ├── configtxgen
│   ├── configtxlator
│   ├── cryptogen
│   ├── discover
│   ├── fabric-ca-client
│   ├── fabric-ca-server
│   ├── ledgerutil
│   ├── orderer
│   ├── osnadmin
│   └── peer
├── config
│   ├── configtx.yaml
│   ├── core.yaml
│   └── orderer.yaml
├── hyperledger-fabric-ca-linux-amd64-1.5.2.tar.gz
└── hyperledger-fabric-linux-amd64-2.4.2.tar.gz
```

### 조직별 CA 서버 설정 파일 작성

link:https://hyperledger-fabric-ca.readthedocs.io/en/latest/users-guide.html[Fabric CA User’s Guide], 
link:https://hyperledger-fabric-ca.readthedocs.io/en/latest/operations_guide.html[Fabric CA Operations Guide], 
link:https://hyperledger-fabric-ca.readthedocs.io/en/latest/deployguide/ca-deploy-topology.html[Planning for a CA], 
link:https://hyperledger-fabric-ca.readthedocs.io/en/latest/deployguide/cadeploy.html[CA Deployment steps]

조직(Organization)별 두 개의 CA(organization CA[블록체인 인증], TLS CA[보안통신 인증]) 설정이 추천되나, 여기서는 하나의 CA가 2개의 CA 역할을 모두 하도록 설정합니다.

조직별로 organizations/fabric-ca/{organizationName} 폴더를 생성하고, 조직별 설정파일(fabric-ca-server-config.yaml)을 작성합니다. 설정파일은 fabric-samples에서 다운받아 수정합니다.

* organizations/fabric-ca/orderer1/fabric-ca-server-config.yaml
* organizations/fabric-ca/platform/fabric-ca-server-config.yaml
* organizations/fabric-ca/customer/fabric-ca-server-config.yaml
* organizations/fabric-ca/service1/fabric-ca-server-config.yaml
* organizations/fabric-ca/service2/fabric-ca-server-config.yaml

```
cd "$FABRIC_NETWORK_HOME"

curl -L https://raw.githubusercontent.com/hyperledger/fabric-samples/main/test-network/organizations/fabric-ca/ordererOrg/fabric-ca-server-config.yaml -o fabric-ca-server-config.yaml

mkdir -p organizations/fabric-ca/orderer1 
mkdir -p organizations/fabric-ca/platform
mkdir -p organizations/fabric-ca/customer
mkdir -p organizations/fabric-ca/service1
mkdir -p organizations/fabric-ca/service2

cp fabric-ca-server-config.yaml organizations/fabric-ca/orderer1
cp fabric-ca-server-config.yaml organizations/fabric-ca/platform
cp fabric-ca-server-config.yaml organizations/fabric-ca/customer
cp fabric-ca-server-config.yaml organizations/fabric-ca/service1
cp fabric-ca-server-config.yaml organizations/fabric-ca/service2

rm fabric-ca-server-config.yaml

```

아래는 파일별 수정한 내용만 표시했습니다.

```
# organizations/fabric-ca/orderer1/fabric-ca-server-config.yaml
...
ca:
  # Name of this CA
  name: Orderer1CA
...
registry:
  # Contains identity information which is used when LDAP is disabled
  identities:
     - name: o1admin
       pass: o1adminpw
...
csr:
   cn: ca.orderer1.moss.com
   names:
      - C: KR
        S: "Gyeonggi-Do"
        L: "Seongnam-si"
        O: Moss
        OU:
   hosts:
     - localhost
     - orderer1.moss.com
...

```

```
# organizations/fabric-ca/platform/fabric-ca-server-config.yaml
...
ca:
  # Name of this CA
  name: PlatformCA
...
registry:
  # Contains identity information which is used when LDAP is disabled
  identities:
     - name: padmin
       pass: padminpw
...
csr:
   cn: ca.platform.moss.com
   names:
      - C: KR
        S: "Gyeonggi-Do"
        L: "Seongnam-si"
        O: platform.moss.com
        OU:
   hosts:
     - localhost
     - platform.moss.com
...

```

```
# organizations/fabric-ca/customer/fabric-ca-server-config.yaml
...
ca:
  # Name of this CA
  name: CustomerCA
...
registry:
  # Contains identity information which is used when LDAP is disabled
  identities:
     - name: cadmin
       pass: cadminpw
...
csr:
   cn: ca.customer.moss.com
   names:
      - C: KR
        S: "Gyeonggi-Do"
        L: "Seongnam-si"
        O: customer.moss.com
        OU:
   hosts:
     - localhost
     - customer.moss.com
...

```

```
# organizations/fabric-ca/service1/fabric-ca-server-config.yaml
...
ca:
  # Name of this CA
  name: Service1CA
...
registry:
  # Contains identity information which is used when LDAP is disabled
  identities:
     - name: s1admin
       pass: s1adminpw
...
csr:
   cn: ca.service1.moss.com
   names:
      - C: KR
        S: "Gyeonggi-Do"
        L: "Seongnam-si"
        O: service1.moss.com
        OU:
   hosts:
     - localhost
     - service1.moss.com
...

```

```
# organizations/fabric-ca/service2/fabric-ca-server-config.yaml
...
ca:
  # Name of this CA
  name: Service2CA
...
registry:
  # Contains identity information which is used when LDAP is disabled
  identities:
     - name: s2admin
       pass: s2adminpw
...
csr:
   cn: ca.service2.moss.com
   names:
      - C: KR
        S: "Gyeonggi-Do"
        L: "Seongnam-si"
        O: service2.moss.com
        OU:
   hosts:
     - localhost
     - service2.moss.com
...

```

작업 후 폴더구조는 아래와 같습니다.

```
/$FABRIC_NETWORK_HOME
...
└── organizations
    └── fabric-ca
        ├── customer
        │   └── fabric-ca-server-config.yaml
        ├── orderer1
        │   └── fabric-ca-server-config.yaml
        ├── platform
        │   └── fabric-ca-server-config.yaml
        ├── service1
        │   └── fabric-ca-server-config.yaml
        └── service2
            └── fabric-ca-server-config.yaml
```

### Fabric-CA 초기화

'fabric-ca-server init'을 'fabric-ca-server-config.yaml' 함께 사용해 Fabric CA를 초기화 합니다.
CA 경로를 'FABRIC_CA_HOME' 환경변수로 지정하거나, '--home' flag로 지정해 주어야 합니다.

초기화가 완료되면 CA의 Identitiy 리소스가 생성됩니다.

```
cd "$FABRIC_NETWORK_HOME"

fabric-ca-server init --home organizations/fabric-ca/orderer1
fabric-ca-server init --home organizations/fabric-ca/platform
fabric-ca-server init --home organizations/fabric-ca/customer
fabric-ca-server init --home organizations/fabric-ca/service1
fabric-ca-server init --home organizations/fabric-ca/service2

```

*orderer1 실행 결과*
```
./$FABRIC_NETWORK_HOME
...
└── organizations
    └── fabric-ca
        ...
        ├── orderer1
        │   ├── IssuerPublicKey
        │   ├── IssuerRevocationPublicKey
        │   ├── ca-cert.pem
        │   ├── fabric-ca-server-config.yaml
        │   ├── fabric-ca-server.db
        │   └── msp
        │       └── keystore
        │           ├── 0088ced00ae5e283443796f7e5a6d37219bde24f6234c3958cc6320f56297c29_sk
        │           ├── IssuerRevocationPrivateKey
        │           └── IssuerSecretKey
        ...
```

* ca-cert.pem: CA 인증서(Certificates)
* fabric-ca-server.db: CA DB(sqllite3) - MySQL 또는 Postgresql로 변경할 수 있습니다.
* msp: Membership Service Provider
* msp/keystore/0088ced00ae5e283443796f7e5a6d37219bde24f6234c3958cc6320f56297c29_sk: CA 개인키
* Issuer~ 파일들: Idemix MSP와 연관된 공개키, 비밀키, link:https://hyperledger-fabric.readthedocs.io/en/release-2.4/idemix.html?highlight=IssuerPublicKey#how-to-use-idemix[How to use Idemix]

*CA 인증서*: ca-cert.pem
```
-----BEGIN CERTIFICATE-----
MIICAjCCAamgAwIBAgIULy4sP4xuIKfleNcduvQWMCJpveEwCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFv
cmRlcmVyMS5tb3NzLmNvbTEdMBsGA1UEAxMUY2Eub3JkZXJlcjEubW9zcy5jb20w
HhcNMjIwMjIzMDczOTAwWhcNMzcwMjE5MDczOTAwWjBeMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEW9yZGVyZXIxLm1vc3MuY29t
MR0wGwYDVQQDExRjYS5vcmRlcmVyMS5tb3NzLmNvbTBZMBMGByqGSM49AgEGCCqG
SM49AwEHA0IABJK4ePqTq3trxPMYftaURRucZF0SDtPbG/x6pQ9X/bl6HuW4nC5S
uixX1yVWtYN56ovvzZtC/63DqDSTUZ1+Ij2jRTBDMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEBMB0GA1UdDgQWBBQVLR9tKg/j3Pfa121mCf6cl4IM
tTAKBggqhkjOPQQDAgNHADBEAiBo9z2OWQTpBcUTiMe//RsvLB3mR2NeMS6Tl9Rq
zkrjUwIgWd0YW7osW/nfwViXTj7peHizxK8SSia6MkRF+utD28w=
-----END CERTIFICATE-----
```

*CA 개인키*: msp/keystore/0088ced00ae5e283443796f7e5a6d37219bde24f6234c3958cc6320f56297c29_sk
```
-----BEGIN PRIVATE KEY-----
MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgfMYU9F28vKDpLNcW
VAaIOVm1AJa6HehiM0I17mfef1qhRANCAASSuHj6k6t7a8TzGH7WlEUbnGRdEg7T
2xv8eqUPV/25eh7luJwuUrosV9clVrWDeeqL782bQv+tw6g0k1GdfiI9
-----END PRIVATE KEY-----
```

*orderer1 실행 로그*
```
$ fabric-ca-server init --home organizations/fabric-ca/orderer1
2022/02/23 16:43:44 [INFO] Configuration file location: /moss-network/organizations/fabric-ca/orderer1/fabric-ca-server-config.yaml
2022/02/23 16:43:44 [WARNING] Unknown provider type: ; metrics disabled
2022/02/23 16:43:44 [INFO] Server Version: 1.5.2
2022/02/23 16:43:44 [INFO] Server Levels: &{Identity:2 Affiliation:1 Certificate:1 Credential:1 RAInfo:1 Nonce:1}
2022/02/23 16:43:44 [WARNING] &{69 The specified CA certificate file /moss-network/organizations/fabric-ca/orderer1/ca-cert.pem does not exist}
2022/02/23 16:43:44 [INFO] generating key: &{A:ecdsa S:256}
2022/02/23 16:43:44 [INFO] encoded CSR
2022/02/23 16:43:44 [INFO] signed certificate with serial number 269352255072886714176999719127157165508707073505
2022/02/23 16:43:44 [INFO] The CA key and certificate were generated for CA Orderer1CA
2022/02/23 16:43:44 [INFO] The key was stored by BCCSP provider 'SW'
2022/02/23 16:43:44 [INFO] The certificate is at: /moss-network/organizations/fabric-ca/orderer1/ca-cert.pem
2022/02/23 16:43:44 [INFO] Initialized sqlite3 database at /moss-network/organizations/fabric-ca/orderer1/fabric-ca-server.db
2022/02/23 16:43:45 [INFO] The issuer key was successfully stored. The public key is at: /moss-network/organizations/fabric-ca/orderer1/IssuerPublicKey, secret key is at: /moss-network/organizations/fabric-ca/orderer1/msp/keystore/IssuerSecretKey
2022/02/23 16:43:45 [INFO] Idemix issuer revocation public and secret keys were generated for CA 'Orderer1CA'
2022/02/23 16:43:45 [INFO] The revocation key was successfully stored. The public key is at: /moss-network/organizations/fabric-ca/orderer1/IssuerRevocationPublicKey, private key is at: /moss-network/organizations/fabric-ca/orderer1/msp/keystore/IssuerRevocationPrivateKey
2022/02/23 16:43:45 [INFO] Home directory for default CA: /moss-network/organizations/fabric-ca/orderer1
2022/02/23 16:43:45 [INFO] Initialization was successful
```

### Fabric CA docker-compose 파일 작성 및 container 실행

Fabric CA 구동을 위한 docker-compose 파일을 작성하고 실행합니다.

compose 폴더 생성 후, fabric-samples의 'compose-ca.yaml' 파일을 다운받아 수정하여 작성합니다.
compose-ca.yaml 작성 후 docker-compose를 이용하여 Fabric CA를 실행합니다.

각 CA 서버의 port를 다음과 같이 사용합니다.

|===
|CA|Port

|Orderer1CA|7054

|PlatformCA|8054

|CustomerCA|9054

|Service1CA|10054

|Service2CA|11054

|===

*docker-compose 실행*

```
cd "$FABRIC_NETWORK_HOME"

mkdir compose
curl -L https://raw.githubusercontent.com/hyperledger/fabric-samples/main/test-network/compose/compose-ca.yaml -o compose/compose-ca.yaml

# compose-ca.yml 수정 (아래 참조)

docker-compose -f compose/compose-ca.yaml up -d 2>&1

```

*수정된 compose/compose-ca.yaml*
```
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

version: '3.7'

networks:
  moss:
    name: fabric_moss

services:
  ca_orderer1:
    image: hyperledger/fabric-ca:1.5.2
    labels:
      service: hyperledger-fabric
    environment:
      - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      - FABRIC_CA_SERVER_CA_NAME=ca.orderer1.moss.com
      - FABRIC_CA_SERVER_TLS_ENABLED=true
      - FABRIC_CA_SERVER_PORT=7054
      - FABRIC_CA_SERVER_OPERATIONS_LISTENADDRESS=0.0.0.0:17054
    ports:
      - "7054:7054"
      - "17054:17054"
    command: sh -c 'fabric-ca-server start -d'
    volumes:
      - ../organizations/fabric-ca/orderer1:/etc/hyperledger/fabric-ca-server
    container_name: ca_orderer1
    networks:
      - moss
  ca_platform:
    image: hyperledger/fabric-ca:1.5.2
    labels:
      service: hyperledger-fabric
    environment:
      - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      - FABRIC_CA_SERVER_CA_NAME=ca.platform.moss.com
      - FABRIC_CA_SERVER_TLS_ENABLED=true
      - FABRIC_CA_SERVER_PORT=8054
      - FABRIC_CA_SERVER_OPERATIONS_LISTENADDRESS=0.0.0.0:18054
    ports:
      - "8054:8054"
      - "18054:18054"
    command: sh -c 'fabric-ca-server start -d'
    volumes:
      - ../organizations/fabric-ca/platform:/etc/hyperledger/fabric-ca-server
    container_name: ca_platform
    networks:
      - moss
  ca_customer:
    image: hyperledger/fabric-ca:1.5.2
    labels:
      service: hyperledger-fabric
    environment:
      - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      - FABRIC_CA_SERVER_CA_NAME=ca.customer.moss.com
      - FABRIC_CA_SERVER_TLS_ENABLED=true
      - FABRIC_CA_SERVER_PORT=9054
      - FABRIC_CA_SERVER_OPERATIONS_LISTENADDRESS=0.0.0.0:19054
    ports:
      - "9054:9054"
      - "19054:19054"
    command: sh -c 'fabric-ca-server start -d'
    volumes:
      - ../organizations/fabric-ca/customer:/etc/hyperledger/fabric-ca-server
    container_name: ca_customer
    networks:
      - moss
  ca_service1:
    image: hyperledger/fabric-ca:1.5.2
    labels:
      service: hyperledger-fabric
    environment:
      - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      - FABRIC_CA_SERVER_CA_NAME=ca.service1.moss.com
      - FABRIC_CA_SERVER_TLS_ENABLED=true
      - FABRIC_CA_SERVER_PORT=10054
      - FABRIC_CA_SERVER_OPERATIONS_LISTENADDRESS=0.0.0.0:20054
    ports:
      - "10054:10054"
      - "20054:20054"
    command: sh -c 'fabric-ca-server start -d'
    volumes:
      - ../organizations/fabric-ca/service1:/etc/hyperledger/fabric-ca-server
    container_name: ca_service1
    networks:
      - moss
  ca_service2:
    image: hyperledger/fabric-ca:1.5.2
    labels:
      service: hyperledger-fabric
    environment:
      - FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server
      - FABRIC_CA_SERVER_CA_NAME=ca.service2.moss.com
      - FABRIC_CA_SERVER_TLS_ENABLED=true
      - FABRIC_CA_SERVER_PORT=11054
      - FABRIC_CA_SERVER_OPERATIONS_LISTENADDRESS=0.0.0.0:21054
    ports:
      - "11054:11054"
      - "21054:21054"
    command: sh -c 'fabric-ca-server start -d'
    volumes:
      - ../organizations/fabric-ca/service2:/etc/hyperledger/fabric-ca-server
    container_name: ca_service2
    networks:
      - moss
  
```

*docker-compose 실행 로그*
```
$ docker-compose -f compose/compose-ca.yaml up -d 2>&1
[+] Running 6/6
 ⠿ Network fabric_moss    Created   0.6s
 ⠿ Container ca_orderer1  Started   5.3s
 ⠿ Container ca_platform  Started   6.0s
 ⠿ Container ca_customer  Started   2.8s
 ⠿ Container ca_service1  Started   4.8s
 ⠿ Container ca_service2  Started   5.6s

$ docker container ls --format "table {{.ID}}\t{{.Names}}\t{{.Ports}}\t{{.Image}}"
CONTAINER ID   NAMES         PORTS                                                          IMAGE
2665e4654f10   ca_orderer1   0.0.0.0:7054->7054/tcp, 0.0.0.0:17054->17054/tcp               hyperledger/fabric-ca:1.5.2
9d839e03574d   ca_platform   0.0.0.0:8054->8054/tcp, 7054/tcp, 0.0.0.0:18054->18054/tcp     hyperledger/fabric-ca:1.5.2
ad33f9863d63   ca_customer   0.0.0.0:9054->9054/tcp, 7054/tcp, 0.0.0.0:19054->19054/tcp     hyperledger/fabric-ca:1.5.2
20db8feb19ec   ca_service1   0.0.0.0:10054->10054/tcp, 7054/tcp, 0.0.0.0:20054->20054/tcp   hyperledger/fabric-ca:1.5.2
e53ca1995ae4   ca_service2   0.0.0.0:11054->11054/tcp, 7054/tcp, 0.0.0.0:21054->21054/tcp   hyperledger/fabric-ca:1.5.2
```

*참고: docker-compose down*
```
docker-compose -f compose/compose-ca.yaml down
```

*orderer1 실행 결과* +
Fabric CA가 실행되면 TLS CA Identity 리소스가 생성됩니다.

```
./$FABRIC_NETWORK_HOME
└── organizations
    └── fabric-ca
        ...
        ├── orderer1
        │   ├── msp
        │   │   ├── cacerts
        │   │   ├── keystore
        │   │   │   ├── 1e6b54abf023f7eeaa974224327a407036dc923b39afd82fdeca88be1d1d5118_sk
        │   │   ├── signcerts
        │   │   └── user
        │   └── tls-cert.pem
        ...
```

* tls-cert.pem: TLS CA 인증서(Certificates)
* msp/keystore/1e6b54abf023f7eeaa974224327a407036dc923b39afd82fdeca88be1d1d5118_sk: TLS CA 개인키

*TLS CA 인증서*: tls-cert.pem
```
-----BEGIN CERTIFICATE-----
MIICXzCCAgagAwIBAgIUVk4WBmcAnf5usEjaQ2hDaCjTq4cwCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFv
cmRlcmVyMS5tb3NzLmNvbTEdMBsGA1UEAxMUY2Eub3JkZXJlcjEubW9zcy5jb20w
HhcNMjIwMjIzMDg1NzAwWhcNMjMwMjIzMDg1NzAwWjBWMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEW9yZGVyZXIxLm1vc3MuY29t
MRUwEwYDVQQDEwwxNmRmNGUzYTEyOTQwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNC
AARcu+pT4mwEcp1TPWYF4UcYsBQ/4pY4t0Y6h0RHvGWXstYO/VY/R7Jp7ZnqCpWr
d6kaoNJ1WqlMsm8yQ4V1U97ao4GpMIGmMA4GA1UdDwEB/wQEAwIDqDAdBgNVHSUE
FjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwDAYDVR0TAQH/BAIwADAdBgNVHQ4EFgQU
pRhxzgxKIR8jW1m4brs9FAxf52MwHwYDVR0jBBgwFoAUFS0fbSoP49z32tdtZgn+
nJeCDLUwJwYDVR0RBCAwHoIJbG9jYWxob3N0ghFvcmRlcmVyMS5tb3NzLmNvbTAK
BggqhkjOPQQDAgNHADBEAiBPStUJPx5F6wk7qvjdPnDI0Jaa0Lzkk/aaa0ZoX9pd
vgIgWXQZu9cOQVXp+J9yFEkc6aVe5/maZi/ETL10NGM8wnk=
-----END CERTIFICATE-----
```

*TLS CA 개인키*: msp/keystore/1e6b54abf023f7eeaa974224327a407036dc923b39afd82fdeca88be1d1d5118_sk
```
-----BEGIN PRIVATE KEY-----
MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgXVJDmmTIl7OtaQRr
EeTa4PKAjdIzQODZCaNLVdFPaoChRANCAARcu+pT4mwEcp1TPWYF4UcYsBQ/4pY4
t0Y6h0RHvGWXstYO/VY/R7Jp7ZnqCpWrd6kaoNJ1WqlMsm8yQ4V1U97a
-----END PRIVATE KEY-----
```

### 조직별 Identity 작업

'fabric-ca-client enroll', 'fabric-ca-client register'를 사용하여 조직별 Identity 작업을 진행합니다.

. *Orderer 조직*
.. enroll 이용하여 CA admin 등록
.. 기본 설정 파일(fabric-ca-client-config.yaml) 수정 (CA Admin enroll시 생성)
.. register 이용하여 Admin 등록 (orderer1Admin)
.. enroll 이용하여 Admin msp 생성 (orderer1Admin)
.. register 이용하여 Orderer 등록(osn1.orerder1, osn2.orerder1, osn3.orerder1)
.. enroll 이용하여 Orderer msp 생성(osn1.orerder1, osn2.orerder1, osn3.orerder1)
.. enroll 이용하여 Orderer TLS certificates 생성(osn1-tls.orerder1, osn2-tls.orerder1, osn3-tls.orerder1)

. *Peer 조직*
.. enroll 이용하여 CA admin 등록(enroll)
.. 기본 설정 파일(fabric-ca-client-config.yaml) 수정 (CA Admin enroll시 생성)
.. register 이용하여 Peer 등록(register) (peer0, peer1)
.. enroll 이용하여 Peer msp 생성 (peer0, peer1)
.. enroll 이용하여 Peer TLS certificates 생성 (peer0-tls, peer1-tls)
.. register 이용하여 User admin 등록 (admin)
.. enroll 이용하여 User admin msp 생성 (admin)
.. register 이용하여 User user 등록 (user1)
.. enroll 이용하여 User user msp 생성 (user1)


fabric-ca-client를 이용하여 Fabric CA Server 호출를 위해서는 admin id 및 password와 ca-cert.pem 파일이 필요합니다.

#### Orderer 조직
*orderer1 - eroll CA Admin*

정렬자조직 폴더를 생성하고, 해당 경로를 FABRIC_CA_CLINET_HOME 환경변수로 설정 후, enroll 명령을 수행합니다.

```
cd "$FABRIC_NETWORK_HOME"

# enroll CA Admin
mkdir -p organizations/ordererOrganizations/orderer1.moss.com
export FABRIC_CA_CLIENT_HOME=${PWD}/organizations/ordererOrganizations/orderer1.moss.com
fabric-ca-client enroll -u https://o1admin:o1adminpw@localhost:7054 --caname "ca.orderer1.moss.com" --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"
```

*orderer1 - eroll CA Admin 결과 및 로그*
```
./$FABRIC_NETWORK_HOME
...
└── organizations
    ...
    └── ordererOrganizations
        └── orderer1.moss.com
            ├── fabric-ca-client-config.yaml
            └── msp
                ├── IssuerPublicKey
                ├── IssuerRevocationPublicKey
                ├── cacerts
                │   └── localhost-7054-ca-orderer1-moss-com.pem
                ├── keystore
                │   └── c50209c4e52e67dd04cef356efbd36af08bc3e0d07f23768e20f899600ae1ef1_sk
                ├── signcerts
                │   └── cert.pem
                └── user
```

* orderer1.moss.com/fabric-ca-client-config.yaml: 기본 설정 파일
* orderer1.moss.com/msp/signcerts/cert.pem: Client Certificates
* orderer1.moss.com/msp/keystore/c50209c4e52e67dd04cef356efbd36af08bc3e0d07f23768e20f899600ae1ef1_sk: Client 개인키
* orderer1.moss.com/msp/cacerts/localhost-7054-ca-orderer1-moss-com.pem: Root CA Certificates


```
$ fabric-ca-client enroll -u https://o1admin:o1adminpw@localhost:7054 --caname "ca.orderer1.moss.com" --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"
2022/02/23 20:29:31 [INFO] Created a default configuration file at /moss-network/organizations/ordererOrganizations/orderer1.moss.com/fabric-ca-client-config.yaml
2022/02/23 20:29:31 [INFO] TLS Enabled
2022/02/23 20:29:31 [INFO] generating key: &{A:ecdsa S:256}
2022/02/23 20:29:31 [INFO] encoded CSR
2022/02/23 20:29:31 [INFO] Stored client certificate at /moss-network/organizations/ordererOrganizations/orderer1.moss.com/msp/signcerts/cert.pem
2022/02/23 20:29:31 [INFO] Stored root CA certificate at /moss-network/organizations/ordererOrganizations/orderer1.moss.com/msp/cacerts/localhost-7054-ca-orderer1-moss-com.pem
2022/02/23 20:29:31 [INFO] Stored Issuer public key at /moss-network/organizations/ordererOrganizations/orderer1.moss.com/msp/IssuerPublicKey
2022/02/23 20:29:31 [INFO] Stored Issuer revocation public key at /moss-network/organizations/ordererOrganizations/orderer1.moss.com/msp/IssuerRevocationPublicKey
```

*orderer1 - Client Certificates(인증서)*: orderer1.moss.com/msp/signcerts/cert.pem
```
-----BEGIN CERTIFICATE-----
MIICMzCCAdqgAwIBAgIUQRRPu4+pBQaxnzXSIleLFhlG/K4wCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFv
cmRlcmVyMS5tb3NzLmNvbTEdMBsGA1UEAxMUY2Eub3JkZXJlcjEubW9zcy5jb20w
HhcNMjIwMjIzMDczOTAwWhcNMjMwMjIzMTEzMDAwWjBfMQswCQYDVQQGEwJVUzEX
MBUGA1UECBMOTm9ydGggQ2Fyb2xpbmExFDASBgNVBAoTC0h5cGVybGVkZ2VyMQ8w
DQYDVQQLEwZjbGllbnQxEDAOBgNVBAMTB28xYWRtaW4wWTATBgcqhkjOPQIBBggq
hkjOPQMBBwNCAATFSK/u8pXbunvkNkMSF8H44L9/sQUTIV64iybZfgHmOateH/YF
9EDWxfS84QyLz1t+LGhgR0GOHRiD3kV1Ohiao3UwczAOBgNVHQ8BAf8EBAMCB4Aw
DAYDVR0TAQH/BAIwADAdBgNVHQ4EFgQUsWK/nXE4He9t0EC0be06Fh3USvIwHwYD
VR0jBBgwFoAUFS0fbSoP49z32tdtZgn+nJeCDLUwEwYDVR0RBAwwCoIIbW9zczA4
MDEwCgYIKoZIzj0EAwIDRwAwRAIgTf70NDJzXQ4DtTB2dc5FtzPutXxMUNYFZ2zl
NsBH6U4CIER2Mbkl/pztLDbsVS60eI6/ci13nWkJGUEkzTX5EQB4
-----END CERTIFICATE-----
```

*orderer1 - Client PrivateKey(개인키)*: orderer1.moss.com/msp/keystore/c50209c4e52e67dd04cef356efbd36af08bc3e0d07f23768e20f899600ae1ef1_sk
```
-----BEGIN PRIVATE KEY-----
MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgvSxekvZMQdA7/PcC
9iWy+EseN29RLddrTYRppTSKOWyhRANCAATFSK/u8pXbunvkNkMSF8H44L9/sQUT
IV64iybZfgHmOateH/YF9EDWxfS84QyLz1t+LGhgR0GOHRiD3kV1Ohia
-----END PRIVATE KEY-----
```

*orderer1 - Root CA Certificates(인증서)*: orderer1.moss.com/msp/cacerts/localhost-7054-ca-orderer1-moss-com.pem +
organizations/fabric-ca/orderer1/ca-cert.pem 과 동일 파일이다.
```
-----BEGIN CERTIFICATE-----
MIICAjCCAamgAwIBAgIULy4sP4xuIKfleNcduvQWMCJpveEwCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFv
cmRlcmVyMS5tb3NzLmNvbTEdMBsGA1UEAxMUY2Eub3JkZXJlcjEubW9zcy5jb20w
HhcNMjIwMjIzMDczOTAwWhcNMzcwMjE5MDczOTAwWjBeMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEW9yZGVyZXIxLm1vc3MuY29t
MR0wGwYDVQQDExRjYS5vcmRlcmVyMS5tb3NzLmNvbTBZMBMGByqGSM49AgEGCCqG
SM49AwEHA0IABJK4ePqTq3trxPMYftaURRucZF0SDtPbG/x6pQ9X/bl6HuW4nC5S
uixX1yVWtYN56ovvzZtC/63DqDSTUZ1+Ij2jRTBDMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEBMB0GA1UdDgQWBBQVLR9tKg/j3Pfa121mCf6cl4IM
tTAKBggqhkjOPQQDAgNHADBEAiBo9z2OWQTpBcUTiMe//RsvLB3mR2NeMS6Tl9Rq
zkrjUwIgWd0YW7osW/nfwViXTj7peHizxK8SSia6MkRF+utD28w=
-----END CERTIFICATE-----
```

*orderer1 - msp/config.yaml 파일 생성*

link:https://hyperledger-fabric.readthedocs.io/en/release-2.4/msp.html#organizational-units[Organizational Units]

OU(Organizational Units)가 MSP의 유효한 멤버(member)인 것을 설정하기 위해서는 X.509 인증서(certificate)가 필요합니다. OU의 Identities를 명시하기 위해서 *config.yaml* 파일이 필요하기에 'organizations/ordererOrganizations/orderer1.moss.com/msp' 경로에 config.yaml 파일을 아래와 같이 작성합니다.

* *Identity classification(분류)*
** *client*: 네트워크에서 거래(트랜잭션)
** *admin*: 관리 업무 처리(채널에 peer 참여(join), 채널설정 수정 트랜잭션의 서명 등)
** *peer*: 트랜잭션 보증(endorese) 및 커밋(commit)
** *orderer*: 정렬 노드(ordering node)에 소속

```
# organizations/ordererOrganizations/orderer1.moss.com/msp/config.yaml
NodeOUs:
  Enable: true
  # For each identity classification that you would like to utilize, specify
  # an OU identifier.
  # You can optionally configure that the OU identifier must be issued by a specific CA
  # or intermediate certificate from your organization. However, it is typical to NOT
  # configure a specific Certificate. By not configuring a specific Certificate, you will be
  # able to add other CA or intermediate certs later, without having to reissue all credentials.
  # For this reason, the sample below comments out the Certificate field.
  ClientOUIdentifier:
    Certificate: "cacerts/localhost-7054-ca-orderer1-moss-com.pem"
    OrganizationalUnitIdentifier: "client"
  AdminOUIdentifier:
    Certificate: "cacerts/localhost-7054-ca-orderer1-moss-com.pem"
    OrganizationalUnitIdentifier: "admin"
  PeerOUIdentifier:
    Certificate: "cacerts/localhost-7054-ca-orderer1-moss-com.pem"
    OrganizationalUnitIdentifier: "peer"
  OrdererOUIdentifier:
    Certificate: "cacerts/localhost-7054-ca-orderer1-moss-com.pem"
    OrganizationalUnitIdentifier: "orderer"
```

Identity classification은 'NodeOUs.Enable'을 'true'로 설정하면 활성화 되고, client(admin, peer, orderer) OU Identifier가 'NodeOUs.ClientOUIdentifier' ('NodeOUs.AdminOUIdentifier', 'NodeOUs.PeerOUIdentifier', 'NodeOUs.OrdererOUIdentifier') 키의 속성 값으로 정의됩니다.

* *OrganizationalUnitIdentifier*: x509 인증서가 client(admin, peer, orderer)로 간주되기 위해 포함해야 하는 OU 값입니다. 필드가 비어 있으면 적용되지 않습니다.
* *Certificate*: (Optional) CA 또는 intermedicate CA 인증서 경로를 MSP root 폴더의 상대경로로 지정합니다. 오직 하나의 인증서만 설정할 수 있고, 값을 설정하지 않으면 조직의 MSP 설정에 정의된 CA 중 하나에서만 유효하면 됩니다.

 파일에서 'Certificate'는 CA 또는 intermediate CA 인증서 경로를 나타냅니다. 경로는 MSP root 폴더를 기준으로 상대적 경로이고 규칙을 따른다면 생략 가능합니다.

*orderer1 - CA 인증서 복사* +
CA 서버가 조직 CA와 TLS CA를 모두 제공하기 때문에, CA에 의해 생성된 조직의 Root 인증서를 tlsca 폴더에도 복사합니다.

```
cd "$FABRIC_NETWORK_HOME"

# copy CA cert to /msp/tlscacerts (for use in the channel MSP definition)
mkdir -p "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/msp/tlscacerts"
cp "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem" "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/msp/tlscacerts/tlsca.orderer1.moss.com-cert.pem"

# copy CA cert to /tlsca (for use by clients)
mkdir -p "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/tlsca"
cp "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem" "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/tlsca/tlsca.orderer1.moss.com-cert.pem"
```

*orderer1 - config.yaml 추가 및 CA 인증서 복사 결과*
```
./$FABRIC_NETWORK_HOME
...
└── organizations
    ├── fabric-ca
    ...
    │   ├── orderer1
    │   │   ├── ca-cert.pem # orderer1 CA Certificateion
    ...
    └── ordererOrganizations
        └── orderer1.moss.com
            ...
            ├── msp
            ...
            │   ├── config.yaml
            │   ├── tlscacerts
            │   │   └── tlsca.orderer1.moss.com-cert.pem
            └── tlsca
                └── tlsca.orderer1.moss.com-cert.pem
```

*orderer1 - osn1, osn2, osn3, amdin를 CA에 register*

OSN: Ordering Service Node

orderer1 조직에 orderer 'osn1', 'osn2', 'osn3'와 admin 'orderer1Admin'을 CA에 register 합니다.

```
cd "$FABRIC_NETWORK_HOME"

fabric-ca-client register --caname ca.orderer1.moss.com --id.name osn1 --id.secret osn1pw --id.type orderer --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"
fabric-ca-client register --caname ca.orderer1.moss.com --id.name osn2 --id.secret osn2pw --id.type orderer --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"
fabric-ca-client register --caname ca.orderer1.moss.com --id.name osn3 --id.secret osn3pw --id.type orderer --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"

fabric-ca-client register --caname ca.orderer1.moss.com --id.name orderer1Admin --id.secret orderer1Adminpw --id.type admin --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"

```

*orderer1 - osn1, osn2, osn3, admin의 msp 생성 및 TLS 인증서 복사*

osn1, osn2, osn3, admin의 msp를 생성(enroll)하고, 조직의 msp/config.yaml을 복사합니다.

```
cd "$FABRIC_NETWORK_HOME"

# enroll
fabric-ca-client enroll -u https://osn1:osn1pw@localhost:7054 --caname ca.orderer1.moss.com -M "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/msp" --csr.hosts osn1.orderer1.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"
fabric-ca-client enroll -u https://osn2:osn2pw@localhost:7054 --caname ca.orderer1.moss.com -M "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/msp" --csr.hosts osn2.orderer1.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"
fabric-ca-client enroll -u https://osn3:osn3pw@localhost:7054 --caname ca.orderer1.moss.com -M "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/msp" --csr.hosts osn3.orderer1.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"

fabric-ca-client enroll -u https://orderer1Admin:orderer1Adminpw@localhost:7054 --caname ca.orderer1.moss.com -M "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/users/Admin@orderer1.moss.com/msp" --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"

# copy msp/config.yaml
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/msp/config.yaml" "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/msp/config.yaml"
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/msp/config.yaml" "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/msp/config.yaml"
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/msp/config.yaml" "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/msp/config.yaml"

cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/msp/config.yaml" "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/users/Admin@orderer1.moss.com/msp/config.yaml"

```

enroll 후 결과
```
./$FABRIC_NETWORK_HOME
...
└── organizations
    ...
    └── ordererOrganizations
        └── orderer1.moss.com
            ...
            ├── orderers
            │   ├── osn1.orderer1.moss.com
            │   │   └── msp
            │   │       ├── IssuerPublicKey
            │   │       ├── IssuerRevocationPublicKey
            │   │       ├── cacerts
            │   │       │   └── localhost-7054-ca-orderer1-moss-com.pem
            │   │       ├── config.yaml
            │   │       ├── keystore
            │   │       │   └── fecacf6499484b0af8afb1f47c9c82358ab8f853fbbc8335139a1e49ab42a695_sk
            │   │       ├── signcerts
            │   │       │   └── cert.pem
            │   │       └── user
            │   ├── osn2.orderer1.moss.com
            │   │   └── msp
            │   │       ├── IssuerPublicKey
            │   │       ├── IssuerRevocationPublicKey
            │   │       ├── cacerts
            │   │       │   └── localhost-7054-ca-orderer1-moss-com.pem
            │   │       ├── config.yaml
            │   │       ├── keystore
            │   │       │   └── a6be1b4829cf2a1c8bdb9305fc289a31d66032a7d7f6e3c12223e0afe76aed54_sk
            │   │       ├── signcerts
            │   │       │   └── cert.pem
            │   │       └── user
            │   └── osn3.orderer1.moss.com
            │       └── msp
            │           ├── IssuerPublicKey
            │           ├── IssuerRevocationPublicKey
            │           ├── cacerts
            │           │   └── localhost-7054-ca-orderer1-moss-com.pem
            │           ├── config.yaml
            │           ├── keystore
            │           │   └── b0ecf1d7d50824df50aa7c1612b9b5b3d87e6eee07721ead1ba42c517aa5eebb_sk
            │           ├── signcerts
            │           │   └── cert.pem
            │           └── user
            ...
            └── users
                └── Admin@orderer1.moss.com
                    └── msp
                        ├── IssuerPublicKey
                        ├── IssuerRevocationPublicKey
                        ├── cacerts
                        │   └── localhost-7054-ca-orderer1-moss-com.pem
                        ├── config.yaml
                        ├── keystore
                        │   └── 732b0591d867142254cd768c7c1d5cb19b378bca4df30b2b08e3f1006b2ec39f_sk
                        ├── signcerts
                        │   └── cert.pem
                        └── user
```

node인 orderer(osn1, osn2, osn3)는 TLS certificates를 생성합니다. +
orderer 시작시 설정에 의해 참조될 수 있도록, TLS CA cert, server cert, server keystore를 잘 알려임 이름으로 tls 폴더에 복사합니다. +
orderer MSP 정의에서 사용하기 위해서 CA의 인증서를 /msp/tlscacerts 폴더로 복사합니다.

```
cd "$FABRIC_NETWORK_HOME"

# Generating the tls certificates
fabric-ca-client enroll -u https://osn1:osn1pw@localhost:7054 --caname ca.orderer1.moss.com -M "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/tls" --enrollment.profile tls --csr.hosts osn1.orderer1.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"
fabric-ca-client enroll -u https://osn2:osn2pw@localhost:7054 --caname ca.orderer1.moss.com -M "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/tls" --enrollment.profile tls --csr.hosts osn2.orderer1.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"
fabric-ca-client enroll -u https://osn3:osn3pw@localhost:7054 --caname ca.orderer1.moss.com -M "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/tls" --enrollment.profile tls --csr.hosts osn3.orderer1.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/orderer1/ca-cert.pem"

# osn1
## Copy the tls CA cert, server cert, server keystore to well known file names in the orderer's tls directory that are referenced by orderer startup config
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/tls/tlscacerts/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/tls/ca.crt"
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/tls/signcerts/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/tls/server.crt"
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/tls/keystore/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/tls/server.key"

## Copy orderer org's CA cert to orderer's /msp/tlscacerts directory (for use in the orderer MSP definition)
mkdir -p "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/msp/tlscacerts"
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/tls/tlscacerts/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn1.orderer1.moss.com/msp/tlscacerts/tlsca.orderer1.moss.com-cert.pem"

# osn2
## Copy the tls CA cert, server cert, server keystore to well known file names in the orderer's tls directory that are referenced by orderer startup config
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/tls/tlscacerts/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/tls/ca.crt"
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/tls/signcerts/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/tls/server.crt"
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/tls/keystore/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/tls/server.key"

## Copy orderer org's CA cert to orderer's /msp/tlscacerts directory (for use in the orderer MSP definition)
mkdir -p "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/msp/tlscacerts"
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/tls/tlscacerts/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn2.orderer1.moss.com/msp/tlscacerts/tlsca.orderer1.moss.com-cert.pem"

# osn3
## Copy the tls CA cert, server cert, server keystore to well known file names in the orderer's tls directory that are referenced by orderer startup config
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/tls/tlscacerts/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/tls/ca.crt"
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/tls/signcerts/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/tls/server.crt"
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/tls/keystore/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/tls/server.key"

## Copy orderer org's CA cert to orderer's /msp/tlscacerts directory (for use in the orderer MSP definition)
mkdir -p "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/msp/tlscacerts"
cp "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/tls/tlscacerts/"* "${PWD}/organizations/ordererOrganizations/orderer1.moss.com/orderers/osn3.orderer1.moss.com/msp/tlscacerts/tlsca.orderer1.moss.com-cert.pem"

```

orderer TLS certificates 생성 및 파일 복사 결과
```
./$FABRIC_NETWORK_HOME
...
└── organizations
    ...
    └── ordererOrganizations
        └── orderer1.moss.com
            ...
            ├── orderers
            │   ├── osn1.orderer1.moss.com
            │   │   ├── msp
                        ...
            │   │   │   └── tlscacerts
            │   │   │       └── tlsca.orderer1.moss.com-cert.pem
            │   │   └── tls
            │   │       ├── ca.crt
            │   │       ├── server.crt
            │   │       ├── server.key
            │   │       ├── IssuerPublicKey
            │   │       ├── IssuerRevocationPublicKey
            │   │       ├── cacerts
            │   │       ├── keystore
            │   │       │   └── 7f96f517feeed09257535a3f1c49d388b96cf52b0755e400ad9e7aec3878a11b_sk
            │   │       ├── signcerts
            │   │       │   └── cert.pem
            │   │       └── tlscacerts
            │   │           └── tls-localhost-7054-ca-orderer1-moss-com.pem
            │   ├── osn2.orderer1.moss.com
            │   │   ├── msp
                        ...
            │   │   │   ├── tlscacerts
            │   │   │   │   └── tlsca.orderer1.moss.com-cert.pem
            │   │   │   └── user
            │   │   └── tls
            │   │       ├── ca.crt
            │   │       ├── server.crt
            │   │       ├── server.key
            │   │       ├── IssuerPublicKey
            │   │       ├── IssuerRevocationPublicKey
            
            │   │       ├── cacerts
            │   │       ├── keystore
            │   │       │   └── ecda61559d7e8240c1a33d1b59003078a02f126de9cb4e4a723d3f873a4e8019_sk
            │   │       ├── signcerts
            │   │       │   └── cert.pem
            │   │       └── tlscacerts
            │   │           └── tls-localhost-7054-ca-orderer1-moss-com.pem
            │   └── osn3.orderer1.moss.com
            │       ├── msp
                        ...
            │       │   ├── tlscacerts
            │       │   │   └── tlsca.orderer1.moss.com-cert.pem
            │       │   └── user
            │       └── tls
            │           ├── ca.crt
            │           ├── server.crt
            │           ├── server.key
            │           ├── IssuerPublicKey
            │           ├── IssuerRevocationPublicKey
            │           ├── cacerts
            │           ├── keystore
            │           │   └── 8c1c3d930c44378de07a4c340c9a60b7d89f96a47c42a15722deea3390a7d161_sk
            │           ├── signcerts
            │           │   └── cert.pem
            │           ├── tlscacerts
            │           │   └── tls-localhost-7054-ca-orderer1-moss-com.pem
            │           └── user
            ...
```

#### Peer 조직

platform 조직을 기준으로 작업하고, 나머지 조직은 동일한 방식으로 진행합니다.

*paltform - eroll CA Admin*

피어조직 폴더를 생성하고, 해당 경로를 FABRIC_CA_CLINET_HOME 환경변수로 설정 후, enroll 명령을 수행합니다.

```
cd "$FABRIC_NETWORK_HOME"

mkdir -p organizations/peerOrganizations/platform.moss.com
export FABRIC_CA_CLIENT_HOME=${PWD}/organizations/peerOrganizations/platform.moss.com

# enroll CA Admin
fabric-ca-client enroll -u https://padmin:padminpw@localhost:8054 --caname "ca.platform.moss.com" --tls.certfiles "${PWD}/organizations/fabric-ca/platform/ca-cert.pem"

```

실행 결과
```
./$FABRIC_NETWORK_HOME
└── organizations
    ├── fabric-ca
        ...
    │   ├── platform
    │   │   ├── ca-cert.pem
            ...
    └── peerOrganizations
        └── platform.moss.com
            ├── fabric-ca-client-config.yaml
            └── msp
                ├── IssuerPublicKey
                ├── IssuerRevocationPublicKey
                ├── cacerts
                │   └── localhost-8054-ca-platform-moss-com.pem
                ├── keystore
                │   └── 49a94d9f5d6e65ffb6df5da88d3e0954674c7001d6913abdb5e17134b8518461_sk
                ├── signcerts
                │   └── cert.pem
                └── user
```

*platform - msp/config.yaml 파일 생성*

```
# organizations/peerOrganizations/platform.moss.com/msp/config.yaml
NodeOUs:
  Enable: true
  # For each identity classification that you would like to utilize, specify
  # an OU identifier.
  # You can optionally configure that the OU identifier must be issued by a specific CA
  # or intermediate certificate from your organization. However, it is typical to NOT
  # configure a specific Certificate. By not configuring a specific Certificate, you will be
  # able to add other CA or intermediate certs later, without having to reissue all credentials.
  # For this reason, the sample below comments out the Certificate field.
  ClientOUIdentifier:
    Certificate: "cacerts/localhost-8054-ca-platform-moss-com.pem"
    OrganizationalUnitIdentifier: "client"
  AdminOUIdentifier:
    Certificate: "cacerts/localhost-8054-ca-platform-moss-com.pem"
    OrganizationalUnitIdentifier: "admin"
  PeerOUIdentifier:
    Certificate: "cacerts/localhost-8054-ca-platform-moss-com.pem"
    OrganizationalUnitIdentifier: "peer"
  OrdererOUIdentifier:
    Certificate: "cacerts/localhost-8054-ca-platform-moss-com.pem"
    OrganizationalUnitIdentifier: "orderer"
```

*platform - CA 인증서 복사* +
조직 CA 서버가 조직 CA와 TLS CA를 모두 제공하기 때문에, CA에 의해 생성된 조직의 Root 인증서를 ca 및 tlsca 폴더에도 복사합니다.

```
cd "$FABRIC_NETWORK_HOME"

# Copy CA cert to /msp/tlscacerts (for use in the channel MSP definition)
mkdir -p "${PWD}/organizations/peerOrganizations/platform.moss.com/msp/tlscacerts"
cp "${PWD}/organizations/fabric-ca/platform/ca-cert.pem" "${PWD}/organizations/peerOrganizations/platform.moss.com/msp/tlscacerts/ca.crt"

# Copy CA cert to /tlsca directory (for use by clients)
mkdir -p "${PWD}/organizations/peerOrganizations/platform.moss.com/tlsca"
cp "${PWD}/organizations/fabric-ca/platform/ca-cert.pem" "${PWD}/organizations/peerOrganizations/platform.moss.com/tlsca/tlsca.platform.moss.com-cert.pem"

# Copy CA cert to /ca directory (for use by clients)
mkdir -p "${PWD}/organizations/peerOrganizations/platform.moss.com/ca"
cp "${PWD}/organizations/fabric-ca/platform/ca-cert.pem" "${PWD}/organizations/peerOrganizations/platform.moss.com/ca/ca.platform.moss.com-cert.pem"

```

*platform - config.yaml 추가 및 CA 인증서 복사 결과*
```
./$FABRIC_NETWORK_HOME
...
└── organizations
    ├── fabric-ca
    ...
    │   ├── orderer1
    │   │   ├── ca-cert.pem # orderer1 CA Certificateion
    ...
    └── ordererOrganizations
        └── orderer1.moss.com
            ...
            ├── msp
            ...
            │   ├── config.yaml
            └── tlsca
                └── tlsca.orderer1.moss.com-cert.pem
    └── peerOrganizations
        └── platform.moss.com
            ...
            ├── msp
                ...
            │   ├── config.yaml
            │   └── tlscacerts
            │       └── ca.crt
            ├── tlsca
            │   └── tlsca.platform.moss.com-cert.pem
            └── ca
                └── ca.platform.moss.com-cert.pem
```

*platform - peer0, peer1, user1, admin을 CA에 register*

platform 조직에 peer 'peer0, peer1', client 'user1' 및 admin 'platformAdmin'을 CA에 register 합니다.

```
cd "$FABRIC_NETWORK_HOME"

fabric-ca-client register --caname ca.platform.moss.com --id.name peer0 --id.secret peer0pw --id.type peer --tls.certfiles "${PWD}/organizations/fabric-ca/platform/ca-cert.pem"
fabric-ca-client register --caname ca.platform.moss.com --id.name peer1 --id.secret peer1pw --id.type peer --tls.certfiles "${PWD}/organizations/fabric-ca/platform/ca-cert.pem"

fabric-ca-client register --caname ca.platform.moss.com --id.name user1 --id.secret user1pw --id.type client --tls.certfiles "${PWD}/organizations/fabric-ca/platform/ca-cert.pem"

fabric-ca-client register --caname ca.platform.moss.com --id.name platformAdmin --id.secret platformAdminpw --id.type admin --tls.certfiles "${PWD}/organizations/fabric-ca/platform/ca-cert.pem"

```

*platform - peer0, peer1, user1, admin의 msp 생성 및 TLS 인증서 복사*

peer0, peer1, user1, admin의 msp를 생성(enroll)하고, 조직의 msp/config.yaml을 복사합니다.

```
cd "$FABRIC_NETWORK_HOME"

# enroll
fabric-ca-client enroll -u https://peer0:peer0pw@localhost:8054 --caname ca.platform.moss.com -M "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer0.platform.moss.com/msp" --csr.hosts peer0.platform.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/platform/ca-cert.pem"
fabric-ca-client enroll -u https://peer1:peer1pw@localhost:8054 --caname ca.platform.moss.com -M "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer1.platform.moss.com/msp" --csr.hosts peer1.platform.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/platform/ca-cert.pem"

fabric-ca-client enroll -u https://user1:user1pw@localhost:8054 --caname ca.platform.moss.com -M "${PWD}/organizations/peerOrganizations/platform.moss.com/users/User1@platform.moss.com/msp" --tls.certfiles "${PWD}/organizations/fabric-ca/platform/ca-cert.pem"

fabric-ca-client enroll -u https://platformAdmin:platformAdminpw@localhost:8054 --caname ca.platform.moss.com -M "${PWD}/organizations/peerOrganizations/platform.moss.com/users/Admin@platform.moss.com/msp" --tls.certfiles "${PWD}/organizations/fabric-ca/platform/ca-cert.pem"

# copy msp/config.yaml
cp "${PWD}/organizations/peerOrganizations/platform.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer0.platform.moss.com/msp/config.yaml"
cp "${PWD}/organizations/peerOrganizations/platform.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer1.platform.moss.com/msp/config.yaml"

cp "${PWD}/organizations/peerOrganizations/platform.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/platform.moss.com/users/User1@platform.moss.com/msp/config.yaml"

cp "${PWD}/organizations/peerOrganizations/platform.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/platform.moss.com/users/Admin@platform.moss.com/msp/config.yaml"

```

enroll 후 결과
```
./$FABRIC_NETWORK_HOME
...
└── organizations
    ...
    └── peerOrganizations
        └── platform.moss.com
            ...
            ├── msp
                ...
            │   └── config.yaml
            ├── peers
            │   ├── peer0.platform.moss.com
            │   │   └── msp
            │   │       ├── IssuerPublicKey
            │   │       ├── IssuerRevocationPublicKey
            │   │       ├── cacerts
            │   │       │   └── localhost-8054-ca-platform-moss-com.pem
            │   │       ├── config.yaml
            │   │       ├── keystore
            │   │       │   └── 5263783ae48b709e44189bdb2a35220d4ce2698ccf47e77563a29987c3b1f6b4_sk
            │   │       ├── signcerts
            │   │       │   └── cert.pem
            │   │       └── user
            │   └── peer1.platform.moss.com
            │       └── msp
            │           ├── IssuerPublicKey
            │           ├── IssuerRevocationPublicKey
            │           ├── cacerts
            │           │   └── localhost-8054-ca-platform-moss-com.pem
            │           ├── config.yaml
            │           ├── keystore
            │           │   └── 9f961a03e1db643234224515620ff692b5253945a303997f161ec4d23c01d9cf_sk
            │           ├── signcerts
            │           │   └── cert.pem
            │           └── usergi
            └── users
                ├── Admin@platform.moss.com
                │   └── msp
                │       ├── IssuerPublicKey
                │       ├── IssuerRevocationPublicKey
                │       ├── cacerts
                │       │   └── localhost-8054-ca-platform-moss-com.pem
                │       ├── config.yaml
                │       ├── keystore
                │       │   └── 1884e29066c455c3681251b552492015307e218e5cb9e953a851a0e0b1821829_sk
                │       ├── signcerts
                │       │   └── cert.pem
                │       └── user
                └── User1@platform.moss.com
                    └── msp
                        ├── IssuerPublicKey
                        ├── IssuerRevocationPublicKey
                        ├── cacerts
                        │   └── localhost-8054-ca-platform-moss-com.pem
                        ├── config.yaml
                        ├── keystore
                        │   └── fbe3366f4f1c0a3bdf6062b614935aab5c336b0f1980141c46de9160917841c7_sk
                        ├── signcerts
                        │   └── cert.pem
                        └── user
```

node인 peer(peer0, peer1)는 TLS certificates를 생성합니다. +
peer 시작시 설정에 의해 참조될 수 있도록, TLS CA cert, server cert, server keystore를 잘 알려임 이름으로 tls 폴더에 복사합니다.

```
cd "$FABRIC_NETWORK_HOME"

# Generating the tls certificates
fabric-ca-client enroll -u https://peer0:peer0pw@localhost:8054 --caname ca.platform.moss.com -M "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer0.platform.moss.com/tls" --enrollment.profile tls --csr.hosts peer0.platform.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/platform/ca-cert.pem"
fabric-ca-client enroll -u https://peer1:peer1pw@localhost:8054 --caname ca.platform.moss.com -M "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer1.platform.moss.com/tls" --enrollment.profile tls --csr.hosts peer1.platform.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/platform/ca-cert.pem"

# peer0
# Copy the tls CA cert, server cert, server keystore to well known file names in the peer's tls directory that are referenced by peer startup config
cp "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer0.platform.moss.com/tls/tlscacerts/"* "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer0.platform.moss.com/tls/ca.crt"
cp "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer0.platform.moss.com/tls/signcerts/"* "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer0.platform.moss.com/tls/server.crt"
cp "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer0.platform.moss.com/tls/keystore/"* "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer0.platform.moss.com/tls/server.key"

# peer1
# Copy the tls CA cert, server cert, server keystore to well known file names in the peer's tls directory that are referenced by peer startup config
cp "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer1.platform.moss.com/tls/tlscacerts/"* "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer1.platform.moss.com/tls/ca.crt"
cp "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer1.platform.moss.com/tls/signcerts/"* "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer1.platform.moss.com/tls/server.crt"
cp "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer1.platform.moss.com/tls/keystore/"* "${PWD}/organizations/peerOrganizations/platform.moss.com/peers/peer1.platform.moss.com/tls/server.key"

```

peer TLS certificates 생성 및 파일 복사 결과
```
./$FABRIC_NETWORK_HOME
...
└── organizations
    ...
    └── peerOrganizations
        └── platform.moss.com
            ...
            └── peers
                ├── peer0.platform.moss.com
                │   ...
                │   └── tls
                │       ├── IssuerPublicKey
                │       ├── IssuerRevocationPublicKey
                │       ├── ca.crt
                │       ├── cacerts
                │       ├── keystore
                │       │   └── a2b04a74fd95f3cf558054b4a1511d039138164faeb4592f85e6198b8baf7639_sk
                │       ├── server.crt
                │       ├── server.key
                │       ├── signcerts
                │       │   └── cert.pem
                │       ├── tlscacerts
                │       │   └── tls-localhost-8054-ca-platform-moss-com.pem
                │       └── user
                └── peer1.platform.moss.com
                    ...
                    └── tls
                        ├── IssuerPublicKey
                        ├── IssuerRevocationPublicKey
                        ├── ca.crt
                        ├── cacerts
                        ├── keystore
                        │   └── d94f101d2ab377884f0bf62c53619891db85688977c8e6b0fe020ab8913ad09c_sk
                        ├── server.crt
                        ├── server.key
                        ├── signcerts
                        │   └── cert.pem
                        ├── tlscacerts
                        │   └── tls-localhost-8054-ca-platform-moss-com.pem
                        └── user
            
```

*customer, service1, service2 peer 조직*
platform을 참고하여서 customer, service1, service2 peer 조직도 동일하게 진행합니다.

customer - enroll CA admin

```
cd "$FABRIC_NETWORK_HOME"

mkdir -p organizations/peerOrganizations/customer.moss.com
export FABRIC_CA_CLIENT_HOME=${PWD}/organizations/peerOrganizations/customer.moss.com

# enroll CA Admin
fabric-ca-client enroll -u https://cadmin:cadminpw@localhost:9054 --caname "ca.customer.moss.com" --tls.certfiles "${PWD}/organizations/fabric-ca/customer/ca-cert.pem"
```

customer - create msp/config.yaml
```
# organizations/peerOrganizations/customer.moss.com/msp/config.yaml
NodeOUs:
  Enable: true
  # For each identity classification that you would like to utilize, specify
  # an OU identifier.
  # You can optionally configure that the OU identifier must be issued by a specific CA
  # or intermediate certificate from your organization. However, it is typical to NOT
  # configure a specific Certificate. By not configuring a specific Certificate, you will be
  # able to add other CA or intermediate certs later, without having to reissue all credentials.
  # For this reason, the sample below comments out the Certificate field.
  ClientOUIdentifier:
    Certificate: "cacerts/localhost-9054-ca-customer-moss-com.pem"
    OrganizationalUnitIdentifier: "client"
  AdminOUIdentifier:
    Certificate: "cacerts/localhost-9054-ca-customer-moss-com.pem"
    OrganizationalUnitIdentifier: "admin"
  PeerOUIdentifier:
    Certificate: "cacerts/localhost-9054-ca-customer-moss-com.pem"
    OrganizationalUnitIdentifier: "peer"
  OrdererOUIdentifier:
    Certificate: "cacerts/localhost-9054-ca-customer-moss-com.pem"
    OrganizationalUnitIdentifier: "orderer"
```

customer - copy CA cert, register and enroll identity
```
# Copy CA cert to /msp/tlscacerts (for use in the channel MSP definition)
mkdir -p "${PWD}/organizations/peerOrganizations/customer.moss.com/msp/tlscacerts"
cp "${PWD}/organizations/fabric-ca/customer/ca-cert.pem" "${PWD}/organizations/peerOrganizations/customer.moss.com/msp/tlscacerts/ca.crt"

# Copy CA cert to /tlsca directory (for use by clients)
mkdir -p "${PWD}/organizations/peerOrganizations/customer.moss.com/tlsca"
cp "${PWD}/organizations/fabric-ca/customer/ca-cert.pem" "${PWD}/organizations/peerOrganizations/customer.moss.com/tlsca/tlsca.customer.moss.com-cert.pem"

# Copy CA cert to /ca directory (for use by clients)
mkdir -p "${PWD}/organizations/peerOrganizations/customer.moss.com/ca"
cp "${PWD}/organizations/fabric-ca/customer/ca-cert.pem" "${PWD}/organizations/peerOrganizations/customer.moss.com/ca/ca.customer.moss.com-cert.pem"


# register peer0, peer1, user1, admin
fabric-ca-client register --caname ca.customer.moss.com --id.name peer0 --id.secret peer0pw --id.type peer --tls.certfiles "${PWD}/organizations/fabric-ca/customer/ca-cert.pem"
fabric-ca-client register --caname ca.customer.moss.com --id.name peer1 --id.secret peer1pw --id.type peer --tls.certfiles "${PWD}/organizations/fabric-ca/customer/ca-cert.pem"

fabric-ca-client register --caname ca.customer.moss.com --id.name user1 --id.secret user1pw --id.type client --tls.certfiles "${PWD}/organizations/fabric-ca/customer/ca-cert.pem"

fabric-ca-client register --caname ca.customer.moss.com --id.name customerAdmin --id.secret customerAdminpw --id.type admin --tls.certfiles "${PWD}/organizations/fabric-ca/customer/ca-cert.pem"

# enroll
fabric-ca-client enroll -u https://peer0:peer0pw@localhost:9054 --caname ca.customer.moss.com -M "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer0.customer.moss.com/msp" --csr.hosts peer0.customer.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/customer/ca-cert.pem"
fabric-ca-client enroll -u https://peer1:peer1pw@localhost:9054 --caname ca.customer.moss.com -M "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer1.customer.moss.com/msp" --csr.hosts peer1.customer.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/customer/ca-cert.pem"

fabric-ca-client enroll -u https://user1:user1pw@localhost:9054 --caname ca.customer.moss.com -M "${PWD}/organizations/peerOrganizations/customer.moss.com/users/User1@customer.moss.com/msp" --tls.certfiles "${PWD}/organizations/fabric-ca/customer/ca-cert.pem"

fabric-ca-client enroll -u https://customerAdmin:customerAdminpw@localhost:9054 --caname ca.customer.moss.com -M "${PWD}/organizations/peerOrganizations/customer.moss.com/users/Admin@customer.moss.com/msp" --tls.certfiles "${PWD}/organizations/fabric-ca/customer/ca-cert.pem"

# copy msp/config.yaml
cp "${PWD}/organizations/peerOrganizations/customer.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer0.customer.moss.com/msp/config.yaml"
cp "${PWD}/organizations/peerOrganizations/customer.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer1.customer.moss.com/msp/config.yaml"

cp "${PWD}/organizations/peerOrganizations/customer.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/customer.moss.com/users/User1@customer.moss.com/msp/config.yaml"

cp "${PWD}/organizations/peerOrganizations/customer.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/customer.moss.com/users/Admin@customer.moss.com/msp/config.yaml"

# Generating the tls certificates
fabric-ca-client enroll -u https://peer0:peer0pw@localhost:9054 --caname ca.customer.moss.com -M "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer0.customer.moss.com/tls" --enrollment.profile tls --csr.hosts peer0.customer.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/customer/ca-cert.pem"
fabric-ca-client enroll -u https://peer1:peer1pw@localhost:9054 --caname ca.customer.moss.com -M "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer1.customer.moss.com/tls" --enrollment.profile tls --csr.hosts peer1.customer.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/customer/ca-cert.pem"

# peer0
# Copy the tls CA cert, server cert, server keystore to well known file names in the peer's tls directory that are referenced by peer startup config
cp "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer0.customer.moss.com/tls/tlscacerts/"* "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer0.customer.moss.com/tls/ca.crt"
cp "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer0.customer.moss.com/tls/signcerts/"* "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer0.customer.moss.com/tls/server.crt"
cp "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer0.customer.moss.com/tls/keystore/"* "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer0.customer.moss.com/tls/server.key"

# peer1
# Copy the tls CA cert, server cert, server keystore to well known file names in the peer's tls directory that are referenced by peer startup config
cp "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer1.customer.moss.com/tls/tlscacerts/"* "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer1.customer.moss.com/tls/ca.crt"
cp "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer1.customer.moss.com/tls/signcerts/"* "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer1.customer.moss.com/tls/server.crt"
cp "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer1.customer.moss.com/tls/keystore/"* "${PWD}/organizations/peerOrganizations/customer.moss.com/peers/peer1.customer.moss.com/tls/server.key"
```

service1 - enroll CA admin
```
cd "$FABRIC_NETWORK_HOME"

mkdir -p organizations/peerOrganizations/service1.moss.com
export FABRIC_CA_CLIENT_HOME=${PWD}/organizations/peerOrganizations/service1.moss.com

# enroll CA Admin
fabric-ca-client enroll -u https://s1admin:s1adminpw@localhost:10054 --caname "ca.service1.moss.com" --tls.certfiles "${PWD}/organizations/fabric-ca/service1/ca-cert.pem"
```

service1 - create msp/config.yaml
```
# organizations/peerOrganizations/service1.moss.com/msp/config.yaml
NodeOUs:
  Enable: true
  # For each identity classification that you would like to utilize, specify
  # an OU identifier.
  # You can optionally configure that the OU identifier must be issued by a specific CA
  # or intermediate certificate from your organization. However, it is typical to NOT
  # configure a specific Certificate. By not configuring a specific Certificate, you will be
  # able to add other CA or intermediate certs later, without having to reissue all credentials.
  # For this reason, the sample below comments out the Certificate field.
  ClientOUIdentifier:
    Certificate: "cacerts/localhost-10054-ca-service1-moss-com.pem"
    OrganizationalUnitIdentifier: "client"
  AdminOUIdentifier:
    Certificate: "cacerts/localhost-10054-ca-service1-moss-com.pem"
    OrganizationalUnitIdentifier: "admin"
  PeerOUIdentifier:
    Certificate: "cacerts/localhost-10054-ca-service1-moss-com.pem"
    OrganizationalUnitIdentifier: "peer"
  OrdererOUIdentifier:
    Certificate: "cacerts/localhost-10054-ca-service1-moss-com.pem"
    OrganizationalUnitIdentifier: "orderer"
```

service1 - copy CA cert, register and enroll identity
```
# Copy CA cert to /msp/tlscacerts (for use in the channel MSP definition)
mkdir -p "${PWD}/organizations/peerOrganizations/service1.moss.com/msp/tlscacerts"
cp "${PWD}/organizations/fabric-ca/service1/ca-cert.pem" "${PWD}/organizations/peerOrganizations/service1.moss.com/msp/tlscacerts/ca.crt"

# Copy CA cert to /tlsca directory (for use by clients)
mkdir -p "${PWD}/organizations/peerOrganizations/service1.moss.com/tlsca"
cp "${PWD}/organizations/fabric-ca/service1/ca-cert.pem" "${PWD}/organizations/peerOrganizations/service1.moss.com/tlsca/tlsca.service1.moss.com-cert.pem"

# Copy CA cert to /ca directory (for use by clients)
mkdir -p "${PWD}/organizations/peerOrganizations/service1.moss.com/ca"
cp "${PWD}/organizations/fabric-ca/service1/ca-cert.pem" "${PWD}/organizations/peerOrganizations/service1.moss.com/ca/ca.service1.moss.com-cert.pem"


# register peer0, peer1, user1, admin
fabric-ca-client register --caname ca.service1.moss.com --id.name peer0 --id.secret peer0pw --id.type peer --tls.certfiles "${PWD}/organizations/fabric-ca/service1/ca-cert.pem"
fabric-ca-client register --caname ca.service1.moss.com --id.name peer1 --id.secret peer1pw --id.type peer --tls.certfiles "${PWD}/organizations/fabric-ca/service1/ca-cert.pem"

fabric-ca-client register --caname ca.service1.moss.com --id.name user1 --id.secret user1pw --id.type client --tls.certfiles "${PWD}/organizations/fabric-ca/service1/ca-cert.pem"

fabric-ca-client register --caname ca.service1.moss.com --id.name service1Admin --id.secret service1Adminpw --id.type admin --tls.certfiles "${PWD}/organizations/fabric-ca/service1/ca-cert.pem"

# enroll
fabric-ca-client enroll -u https://peer0:peer0pw@localhost:10054 --caname ca.service1.moss.com -M "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer0.service1.moss.com/msp" --csr.hosts peer0.service1.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/service1/ca-cert.pem"
fabric-ca-client enroll -u https://peer1:peer1pw@localhost:10054 --caname ca.service1.moss.com -M "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer1.service1.moss.com/msp" --csr.hosts peer1.service1.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/service1/ca-cert.pem"

fabric-ca-client enroll -u https://user1:user1pw@localhost:10054 --caname ca.service1.moss.com -M "${PWD}/organizations/peerOrganizations/service1.moss.com/users/User1@service1.moss.com/msp" --tls.certfiles "${PWD}/organizations/fabric-ca/service1/ca-cert.pem"

fabric-ca-client enroll -u https://service1Admin:service1Adminpw@localhost:10054 --caname ca.service1.moss.com -M "${PWD}/organizations/peerOrganizations/service1.moss.com/users/Admin@service1.moss.com/msp" --tls.certfiles "${PWD}/organizations/fabric-ca/service1/ca-cert.pem"

# copy msp/config.yaml
cp "${PWD}/organizations/peerOrganizations/service1.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer0.service1.moss.com/msp/config.yaml"
cp "${PWD}/organizations/peerOrganizations/service1.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer1.service1.moss.com/msp/config.yaml"

cp "${PWD}/organizations/peerOrganizations/service1.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/service1.moss.com/users/User1@service1.moss.com/msp/config.yaml"

cp "${PWD}/organizations/peerOrganizations/service1.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/service1.moss.com/users/Admin@service1.moss.com/msp/config.yaml"

# Generating the tls certificates
fabric-ca-client enroll -u https://peer0:peer0pw@localhost:10054 --caname ca.service1.moss.com -M "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer0.service1.moss.com/tls" --enrollment.profile tls --csr.hosts peer0.service1.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/service1/ca-cert.pem"
fabric-ca-client enroll -u https://peer1:peer1pw@localhost:10054 --caname ca.service1.moss.com -M "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer1.service1.moss.com/tls" --enrollment.profile tls --csr.hosts peer1.service1.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/service1/ca-cert.pem"

# peer0
# Copy the tls CA cert, server cert, server keystore to well known file names in the peer's tls directory that are referenced by peer startup config
cp "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer0.service1.moss.com/tls/tlscacerts/"* "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer0.service1.moss.com/tls/ca.crt"
cp "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer0.service1.moss.com/tls/signcerts/"* "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer0.service1.moss.com/tls/server.crt"
cp "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer0.service1.moss.com/tls/keystore/"* "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer0.service1.moss.com/tls/server.key"

# peer1
# Copy the tls CA cert, server cert, server keystore to well known file names in the peer's tls directory that are referenced by peer startup config
cp "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer1.service1.moss.com/tls/tlscacerts/"* "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer1.service1.moss.com/tls/ca.crt"
cp "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer1.service1.moss.com/tls/signcerts/"* "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer1.service1.moss.com/tls/server.crt"
cp "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer1.service1.moss.com/tls/keystore/"* "${PWD}/organizations/peerOrganizations/service1.moss.com/peers/peer1.service1.moss.com/tls/server.key"
```

service2 - enroll CA admin
```
cd "$FABRIC_NETWORK_HOME"

mkdir -p organizations/peerOrganizations/service2.moss.com
export FABRIC_CA_CLIENT_HOME=${PWD}/organizations/peerOrganizations/service2.moss.com

# enroll CA Admin
fabric-ca-client enroll -u https://s2admin:s2adminpw@localhost:11054 --caname "ca.service2.moss.com" --tls.certfiles "${PWD}/organizations/fabric-ca/service2/ca-cert.pem"
```

service2 - create msp/config.yaml
```
# organizations/peerOrganizations/service2.moss.com/msp/config.yaml
NodeOUs:
  Enable: true
  # For each identity classification that you would like to utilize, specify
  # an OU identifier.
  # You can optionally configure that the OU identifier must be issued by a specific CA
  # or intermediate certificate from your organization. However, it is typical to NOT
  # configure a specific Certificate. By not configuring a specific Certificate, you will be
  # able to add other CA or intermediate certs later, without having to reissue all credentials.
  # For this reason, the sample below comments out the Certificate field.
  ClientOUIdentifier:
    Certificate: "cacerts/localhost-11054-ca-service2-moss-com.pem"
    OrganizationalUnitIdentifier: "client"
  AdminOUIdentifier:
    Certificate: "cacerts/localhost-11054-ca-service2-moss-com.pem"
    OrganizationalUnitIdentifier: "admin"
  PeerOUIdentifier:
    Certificate: "cacerts/localhost-11054-ca-service2-moss-com.pem"
    OrganizationalUnitIdentifier: "peer"
  OrdererOUIdentifier:
    Certificate: "cacerts/localhost-11054-ca-service2-moss-com.pem"
    OrganizationalUnitIdentifier: "orderer"
```

service2 - copy CA cert, register and enroll identity
```
# Copy CA cert to /msp/tlscacerts (for use in the channel MSP definition)
mkdir -p "${PWD}/organizations/peerOrganizations/service2.moss.com/msp/tlscacerts"
cp "${PWD}/organizations/fabric-ca/service2/ca-cert.pem" "${PWD}/organizations/peerOrganizations/service2.moss.com/msp/tlscacerts/ca.crt"

# Copy CA cert to /tlsca directory (for use by clients)
mkdir -p "${PWD}/organizations/peerOrganizations/service2.moss.com/tlsca"
cp "${PWD}/organizations/fabric-ca/service2/ca-cert.pem" "${PWD}/organizations/peerOrganizations/service2.moss.com/tlsca/tlsca.service2.moss.com-cert.pem"

# Copy CA cert to /ca directory (for use by clients)
mkdir -p "${PWD}/organizations/peerOrganizations/service2.moss.com/ca"
cp "${PWD}/organizations/fabric-ca/service2/ca-cert.pem" "${PWD}/organizations/peerOrganizations/service2.moss.com/ca/ca.service2.moss.com-cert.pem"


# register peer0, peer1, user1, admin
fabric-ca-client register --caname ca.service2.moss.com --id.name peer0 --id.secret peer0pw --id.type peer --tls.certfiles "${PWD}/organizations/fabric-ca/service2/ca-cert.pem"
fabric-ca-client register --caname ca.service2.moss.com --id.name peer1 --id.secret peer1pw --id.type peer --tls.certfiles "${PWD}/organizations/fabric-ca/service2/ca-cert.pem"

fabric-ca-client register --caname ca.service2.moss.com --id.name user1 --id.secret user1pw --id.type client --tls.certfiles "${PWD}/organizations/fabric-ca/service2/ca-cert.pem"

fabric-ca-client register --caname ca.service2.moss.com --id.name service2Admin --id.secret service2Adminpw --id.type admin --tls.certfiles "${PWD}/organizations/fabric-ca/service2/ca-cert.pem"

# enroll
fabric-ca-client enroll -u https://peer0:peer0pw@localhost:11054 --caname ca.service2.moss.com -M "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer0.service2.moss.com/msp" --csr.hosts peer0.service2.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/service2/ca-cert.pem"
fabric-ca-client enroll -u https://peer1:peer1pw@localhost:11054 --caname ca.service2.moss.com -M "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer1.service2.moss.com/msp" --csr.hosts peer1.service2.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/service2/ca-cert.pem"

fabric-ca-client enroll -u https://user1:user1pw@localhost:11054 --caname ca.service2.moss.com -M "${PWD}/organizations/peerOrganizations/service2.moss.com/users/User1@service2.moss.com/msp" --tls.certfiles "${PWD}/organizations/fabric-ca/service2/ca-cert.pem"

fabric-ca-client enroll -u https://service2Admin:service2Adminpw@localhost:11054 --caname ca.service2.moss.com -M "${PWD}/organizations/peerOrganizations/service2.moss.com/users/Admin@service2.moss.com/msp" --tls.certfiles "${PWD}/organizations/fabric-ca/service2/ca-cert.pem"

# copy msp/config.yaml
cp "${PWD}/organizations/peerOrganizations/service2.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer0.service2.moss.com/msp/config.yaml"
cp "${PWD}/organizations/peerOrganizations/service2.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer1.service2.moss.com/msp/config.yaml"

cp "${PWD}/organizations/peerOrganizations/service2.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/service2.moss.com/users/User1@service2.moss.com/msp/config.yaml"

cp "${PWD}/organizations/peerOrganizations/service2.moss.com/msp/config.yaml" "${PWD}/organizations/peerOrganizations/service2.moss.com/users/Admin@service2.moss.com/msp/config.yaml"

# Generating the tls certificates
fabric-ca-client enroll -u https://peer0:peer0pw@localhost:11054 --caname ca.service2.moss.com -M "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer0.service2.moss.com/tls" --enrollment.profile tls --csr.hosts peer0.service2.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/service2/ca-cert.pem"
fabric-ca-client enroll -u https://peer1:peer1pw@localhost:11054 --caname ca.service2.moss.com -M "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer1.service2.moss.com/tls" --enrollment.profile tls --csr.hosts peer1.service2.moss.com --csr.hosts localhost --tls.certfiles "${PWD}/organizations/fabric-ca/service2/ca-cert.pem"

# peer0
# Copy the tls CA cert, server cert, server keystore to well known file names in the peer's tls directory that are referenced by peer startup config
cp "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer0.service2.moss.com/tls/tlscacerts/"* "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer0.service2.moss.com/tls/ca.crt"
cp "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer0.service2.moss.com/tls/signcerts/"* "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer0.service2.moss.com/tls/server.crt"
cp "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer0.service2.moss.com/tls/keystore/"* "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer0.service2.moss.com/tls/server.key"

# peer1
# Copy the tls CA cert, server cert, server keystore to well known file names in the peer's tls directory that are referenced by peer startup config
cp "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer1.service2.moss.com/tls/tlscacerts/"* "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer1.service2.moss.com/tls/ca.crt"
cp "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer1.service2.moss.com/tls/signcerts/"* "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer1.service2.moss.com/tls/server.crt"
cp "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer1.service2.moss.com/tls/keystore/"* "${PWD}/organizations/peerOrganizations/service2.moss.com/peers/peer1.service2.moss.com/tls/server.key"
```

### Peer 조직 CCP 파일 생성
ccp(common connection profile): application에서 gateway를 설정하여 network 와의 통신을 관리하는 데 사용됩니다.

json과 yaml 형식 중 여기서는 yaml 형식을 사용합니다.

peer의 port는 아래와 같이 사용합니다.

|===
|Organization|Peer|Port

|platform|peer0|8060
|platform|peer1|8061

|customer|peer0|9060
|customer|peer1|9061

|service1|peer0|10060
|service1|peer1|10061

|service2|peer0|11060
|service2|peer1|11061

|===

tlsCACerts.pem은 각각 아래 파일을 참조 합니다.

* peers."{peer}.{organization}.{networkn}".tlsCACerts.pem : tlsca.{organization}.moss.com-cert.pem
* certificateAuthorities.{ca}.tlsCACerts:pem: ca.{organization}.moss.com-cert.pem

예) platform peer0
* peers.peer0.tlsCACerts.pem : organizations/peerOrganizations/platform.moss.com/tlsca/tlsca.platform.moss.com-cert.pem
* certificateAuthorities."ca.platform.moss.com".tlsCACerts:pem: organizations/peerOrganizations/platform.moss.com/ca/ca.platform.moss.com-cert.pem

*organizations/peerOrganizations/platform.moss.com/connection-platform.yaml*
```
---
name: moss-network-platform
version: 1.0.0
client:
  organization: platform
  connection:
    timeout:
      peer:
        endorser: '300'
organizations:
  platform:
    mspid: platformMSP
    peers:
    - peer0.platform.moss.com
    - peer1.platform.moss.com
    certificateAuthorities:
    - ca.platform.moss.com
peers:
  peer0.platform.moss.com:
    url: grpcs://localhost:8060
    tlsCACerts:
      pem: |
          -----BEGIN CERTIFICATE-----
MIICAzCCAamgAwIBAgIUVzw5e+n07j1rIImI7wlENLD4Rs0wCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFw
bGF0Zm9ybS5tb3NzLmNvbTEdMBsGA1UEAxMUY2EucGxhdGZvcm0ubW9zcy5jb20w
HhcNMjIwMjIzMDgyNzAwWhcNMzcwMjE5MDgyNzAwWjBeMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEXBsYXRmb3JtLm1vc3MuY29t
MR0wGwYDVQQDExRjYS5wbGF0Zm9ybS5tb3NzLmNvbTBZMBMGByqGSM49AgEGCCqG
SM49AwEHA0IABBHmSswAYpVwlUo52QxRrtvCYqUOpc9nBGqzl54Z9wWq6QquIUjk
V4YUVC0lGT5iN7k7p4IIZT5iXQPa8IWG88ijRTBDMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEBMB0GA1UdDgQWBBQCgcuPtNGsgKhac1iOso+01Wg8
bDAKBggqhkjOPQQDAgNIADBFAiEAtk8OUrwSCO9Zmsn8QFAeQ+/gMYltJwqO0XPD
ZltK0sACID4foHwSR7wGQzYRZQk2ImkOKQmqzn/cmjulUMlo6S2y
-----END CERTIFICATE-----
    grpcOptions:
      ssl-target-name-override: peer0.platform.moss.com
      hostnameOverride: peer0.platform.moss.com
  peer1.platform.moss.com:
    url: grpcs://localhost:8061
    tlsCACerts:
      pem: |
          -----BEGIN CERTIFICATE-----
MIICAzCCAamgAwIBAgIUVzw5e+n07j1rIImI7wlENLD4Rs0wCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFw
bGF0Zm9ybS5tb3NzLmNvbTEdMBsGA1UEAxMUY2EucGxhdGZvcm0ubW9zcy5jb20w
HhcNMjIwMjIzMDgyNzAwWhcNMzcwMjE5MDgyNzAwWjBeMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEXBsYXRmb3JtLm1vc3MuY29t
MR0wGwYDVQQDExRjYS5wbGF0Zm9ybS5tb3NzLmNvbTBZMBMGByqGSM49AgEGCCqG
SM49AwEHA0IABBHmSswAYpVwlUo52QxRrtvCYqUOpc9nBGqzl54Z9wWq6QquIUjk
V4YUVC0lGT5iN7k7p4IIZT5iXQPa8IWG88ijRTBDMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEBMB0GA1UdDgQWBBQCgcuPtNGsgKhac1iOso+01Wg8
bDAKBggqhkjOPQQDAgNIADBFAiEAtk8OUrwSCO9Zmsn8QFAeQ+/gMYltJwqO0XPD
ZltK0sACID4foHwSR7wGQzYRZQk2ImkOKQmqzn/cmjulUMlo6S2y
-----END CERTIFICATE-----
    grpcOptions:
      ssl-target-name-override: peer1.platform.moss.com
      hostnameOverride: peer1.platform.moss.com
certificateAuthorities:
  ca.platform.moss.com:
    url: https://localhost:8054
    caName: ca.platform.moss.com
    tlsCACerts:
      pem: 
        - |
          -----BEGIN CERTIFICATE-----
MIICAzCCAamgAwIBAgIUVzw5e+n07j1rIImI7wlENLD4Rs0wCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFw
bGF0Zm9ybS5tb3NzLmNvbTEdMBsGA1UEAxMUY2EucGxhdGZvcm0ubW9zcy5jb20w
HhcNMjIwMjIzMDgyNzAwWhcNMzcwMjE5MDgyNzAwWjBeMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEXBsYXRmb3JtLm1vc3MuY29t
MR0wGwYDVQQDExRjYS5wbGF0Zm9ybS5tb3NzLmNvbTBZMBMGByqGSM49AgEGCCqG
SM49AwEHA0IABBHmSswAYpVwlUo52QxRrtvCYqUOpc9nBGqzl54Z9wWq6QquIUjk
V4YUVC0lGT5iN7k7p4IIZT5iXQPa8IWG88ijRTBDMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEBMB0GA1UdDgQWBBQCgcuPtNGsgKhac1iOso+01Wg8
bDAKBggqhkjOPQQDAgNIADBFAiEAtk8OUrwSCO9Zmsn8QFAeQ+/gMYltJwqO0XPD
ZltK0sACID4foHwSR7wGQzYRZQk2ImkOKQmqzn/cmjulUMlo6S2y
-----END CERTIFICATE-----
    httpOptions:
      verify: false
```

*organizations/peerOrganizations/customer.moss.com/connection-customer.yaml*
```
---
name: moss-network-customer
version: 1.0.0
client:
  organization: customer
  connection:
    timeout:
      peer:
        endorser: '300'
organizations:
  customer:
    mspid: customerMSP
    peers:
    - peer0.customer.moss.com
    - peer1.customer.moss.com
    certificateAuthorities:
    - ca.customer.moss.com
peers:
  peer0.customer.moss.com:
    url: grpcs://localhost:9060
    tlsCACerts:
      pem: |
          -----BEGIN CERTIFICATE-----
MIICAzCCAamgAwIBAgIUUI50ijvhR1v86CrEzlk0DWTwbvYwCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFj
dXN0b21lci5tb3NzLmNvbTEdMBsGA1UEAxMUY2EuY3VzdG9tZXIubW9zcy5jb20w
HhcNMjIwMjIzMDgyNzAwWhcNMzcwMjE5MDgyNzAwWjBeMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEWN1c3RvbWVyLm1vc3MuY29t
MR0wGwYDVQQDExRjYS5jdXN0b21lci5tb3NzLmNvbTBZMBMGByqGSM49AgEGCCqG
SM49AwEHA0IABNFj+9eHcFaXDQwd3vA6FP9dLHuQOlJmW0lM4WxodvB5/p6GyOVT
YIpQD/k3Fe6Z9invfV//i1vCe0fxOZOpCKWjRTBDMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEBMB0GA1UdDgQWBBTybLcnSoQKRhQly1TAsMqEkOAV
bDAKBggqhkjOPQQDAgNIADBFAiEAh5JvZ6nWhkGGhFrE8h10cZEH+6dgdRx7VGhY
2NYIKskCIDTMzVPi+YhDgGI2Csu9aXVzs1BO4o9zS/tKZaqhNcz/
-----END CERTIFICATE-----

    grpcOptions:
      ssl-target-name-override: peer0.customer.moss.com
      hostnameOverride: peer0.customer.moss.com
  peer1.customer.moss.com:
    url: grpcs://localhost:9061
    tlsCACerts:
      pem: |
          -----BEGIN CERTIFICATE-----
MIICAzCCAamgAwIBAgIUUI50ijvhR1v86CrEzlk0DWTwbvYwCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFj
dXN0b21lci5tb3NzLmNvbTEdMBsGA1UEAxMUY2EuY3VzdG9tZXIubW9zcy5jb20w
HhcNMjIwMjIzMDgyNzAwWhcNMzcwMjE5MDgyNzAwWjBeMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEWN1c3RvbWVyLm1vc3MuY29t
MR0wGwYDVQQDExRjYS5jdXN0b21lci5tb3NzLmNvbTBZMBMGByqGSM49AgEGCCqG
SM49AwEHA0IABNFj+9eHcFaXDQwd3vA6FP9dLHuQOlJmW0lM4WxodvB5/p6GyOVT
YIpQD/k3Fe6Z9invfV//i1vCe0fxOZOpCKWjRTBDMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEBMB0GA1UdDgQWBBTybLcnSoQKRhQly1TAsMqEkOAV
bDAKBggqhkjOPQQDAgNIADBFAiEAh5JvZ6nWhkGGhFrE8h10cZEH+6dgdRx7VGhY
2NYIKskCIDTMzVPi+YhDgGI2Csu9aXVzs1BO4o9zS/tKZaqhNcz/
-----END CERTIFICATE-----

    grpcOptions:
      ssl-target-name-override: peer1.customer.moss.com
      hostnameOverride: peer1.customer.moss.com
certificateAuthorities:
  ca.customer.moss.com:
    url: https://localhost:9054
    caName: ca.customer.moss.com
    tlsCACerts:
      pem: 
        - |
          -----BEGIN CERTIFICATE-----
MIICAzCCAamgAwIBAgIUUI50ijvhR1v86CrEzlk0DWTwbvYwCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFj
dXN0b21lci5tb3NzLmNvbTEdMBsGA1UEAxMUY2EuY3VzdG9tZXIubW9zcy5jb20w
HhcNMjIwMjIzMDgyNzAwWhcNMzcwMjE5MDgyNzAwWjBeMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEWN1c3RvbWVyLm1vc3MuY29t
MR0wGwYDVQQDExRjYS5jdXN0b21lci5tb3NzLmNvbTBZMBMGByqGSM49AgEGCCqG
SM49AwEHA0IABNFj+9eHcFaXDQwd3vA6FP9dLHuQOlJmW0lM4WxodvB5/p6GyOVT
YIpQD/k3Fe6Z9invfV//i1vCe0fxOZOpCKWjRTBDMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEBMB0GA1UdDgQWBBTybLcnSoQKRhQly1TAsMqEkOAV
bDAKBggqhkjOPQQDAgNIADBFAiEAh5JvZ6nWhkGGhFrE8h10cZEH+6dgdRx7VGhY
2NYIKskCIDTMzVPi+YhDgGI2Csu9aXVzs1BO4o9zS/tKZaqhNcz/
-----END CERTIFICATE-----

    httpOptions:
      verify: false
```

*organizations/peerOrganizations/service1.moss.com/connection-service1.yaml*
```
---
name: moss-network-service1
version: 1.0.0
client:
  organization: service1
  connection:
    timeout:
      peer:
        endorser: '300'
organizations:
  service1:
    mspid: service1MSP
    peers:
    - peer0.service1.moss.com
    - peer1.service1.moss.com
    certificateAuthorities:
    - ca.service1.moss.com
peers:
  peer0.service1.moss.com:
    url: grpcs://localhost:10060
    tlsCACerts:
      pem: |
          -----BEGIN CERTIFICATE-----
MIICAjCCAamgAwIBAgIUY01bq1JKNw9HraIfq6vnyLyzpRIwCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFz
ZXJ2aWNlMS5tb3NzLmNvbTEdMBsGA1UEAxMUY2Euc2VydmljZTEubW9zcy5jb20w
HhcNMjIwMjIzMDgyNzAwWhcNMzcwMjE5MDgyNzAwWjBeMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEXNlcnZpY2UxLm1vc3MuY29t
MR0wGwYDVQQDExRjYS5zZXJ2aWNlMS5tb3NzLmNvbTBZMBMGByqGSM49AgEGCCqG
SM49AwEHA0IABFpfTUbhY/DXGfEMawOzXgR+cRBFIi5CGzpXJR9ZL7CMZRnIx2Ac
Lno268PX3KJaxJ+N6u3aYKaU2qW0b9dtFiSjRTBDMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEBMB0GA1UdDgQWBBTLG8zBlOke5Pk5aMuKf+q7caZ2
gzAKBggqhkjOPQQDAgNHADBEAiAqp6CpsfzKVuSrU8ipOirWVYAOq2kRx9SQ8+52
OvygIgIgC/dDyD5KG4tIAB9GaPCOeOBwswLDgnV67e0Rkgqj8hQ=
-----END CERTIFICATE-----

    grpcOptions:
      ssl-target-name-override: peer0.service1.moss.com
      hostnameOverride: peer0.service1.moss.com
  peer1.service1.moss.com:
    url: grpcs://localhost:10061
    tlsCACerts:
      pem: |
          -----BEGIN CERTIFICATE-----
MIICAjCCAamgAwIBAgIUY01bq1JKNw9HraIfq6vnyLyzpRIwCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFz
ZXJ2aWNlMS5tb3NzLmNvbTEdMBsGA1UEAxMUY2Euc2VydmljZTEubW9zcy5jb20w
HhcNMjIwMjIzMDgyNzAwWhcNMzcwMjE5MDgyNzAwWjBeMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEXNlcnZpY2UxLm1vc3MuY29t
MR0wGwYDVQQDExRjYS5zZXJ2aWNlMS5tb3NzLmNvbTBZMBMGByqGSM49AgEGCCqG
SM49AwEHA0IABFpfTUbhY/DXGfEMawOzXgR+cRBFIi5CGzpXJR9ZL7CMZRnIx2Ac
Lno268PX3KJaxJ+N6u3aYKaU2qW0b9dtFiSjRTBDMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEBMB0GA1UdDgQWBBTLG8zBlOke5Pk5aMuKf+q7caZ2
gzAKBggqhkjOPQQDAgNHADBEAiAqp6CpsfzKVuSrU8ipOirWVYAOq2kRx9SQ8+52
OvygIgIgC/dDyD5KG4tIAB9GaPCOeOBwswLDgnV67e0Rkgqj8hQ=
-----END CERTIFICATE-----

    grpcOptions:
      ssl-target-name-override: peer1.service1.moss.com
      hostnameOverride: peer1.service1.moss.com
certificateAuthorities:
  ca.service1.moss.com:
    url: https://localhost:10054
    caName: ca.service1.moss.com
    tlsCACerts:
      pem: 
        - |
          -----BEGIN CERTIFICATE-----
MIICAjCCAamgAwIBAgIUY01bq1JKNw9HraIfq6vnyLyzpRIwCgYIKoZIzj0EAwIw
XjELMAkGA1UEBhMCS1IxFDASBgNVBAcTC1Nlb25nbmFtLXNpMRowGAYDVQQKExFz
ZXJ2aWNlMS5tb3NzLmNvbTEdMBsGA1UEAxMUY2Euc2VydmljZTEubW9zcy5jb20w
HhcNMjIwMjIzMDgyNzAwWhcNMzcwMjE5MDgyNzAwWjBeMQswCQYDVQQGEwJLUjEU
MBIGA1UEBxMLU2VvbmduYW0tc2kxGjAYBgNVBAoTEXNlcnZpY2UxLm1vc3MuY29t
MR0wGwYDVQQDExRjYS5zZXJ2aWNlMS5tb3NzLmNvbTBZMBMGByqGSM49AgEGCCqG
SM49AwEHA0IABFpfTUbhY/DXGfEMawOzXgR+cRBFIi5CGzpXJR9ZL7CMZRnIx2Ac
Lno268PX3KJaxJ+N6u3aYKaU2qW0b9dtFiSjRTBDMA4GA1UdDwEB/wQEAwIBBjAS
BgNVHRMBAf8ECDAGAQH/AgEBMB0GA1UdDgQWBBTLG8zBlOke5Pk5aMuKf+q7caZ2
gzAKBggqhkjOPQQDAgNHADBEAiAqp6CpsfzKVuSrU8ipOirWVYAOq2kRx9SQ8+52
OvygIgIgC/dDyD5KG4tIAB9GaPCOeOBwswLDgnV67e0Rkgqj8hQ=
-----END CERTIFICATE-----

    httpOptions:
      verify: false
```

*organizations/peerOrganizations/service2.moss.com/connection-service2.yaml*

### network docker-compose 작성 및 실행
orderer, peer, cli node를 위한 docker-compose를 작성하고 실행하여 container를 실행시킵니다.

compose/compose-moss-net.yaml 파일을 참고 합니다.

docker-compose 실행 결과

```
$ docker-compose -f compose/compose-moss-net.yaml up -d 2>&1
[+] Running 0/0
 ⠋ Volume "compose_osn2.orderer1.moss.com"  Creating    0.0s
[+] Running 23/23orphan containers ([ca_orderer1 ca_service1 ca_platform ca_customer ca_service2]) for this project. If you removed or renamed this service in your compose file, you can run this command with t
 ⠿ Volume "compose_osn2.orderer1.moss.com"   Created    0.0s
 ⠿ Volume "compose_peer0.service2.moss.com"  Created    0.0s
 ⠿ Volume "compose_peer1.service1.moss.com"  Created    0.0s
 ⠿ Volume "compose_osn1.orderer1.moss.com"   Created    0.0s
 ⠿ Volume "compose_peer0.platform.moss.com"  Created    0.0s
 ⠿ Volume "compose_peer1.service2.moss.com"  Created    0.0s
 ⠿ Volume "compose_osn3.orderer1.moss.com"   Created    0.0s
 ⠿ Volume "compose_peer1.customer.moss.com"  Created    0.0s
 ⠿ Volume "compose_peer1.platform.moss.com"  Created    0.0s
 ⠿ Volume "compose_peer0.customer.moss.com"  Created    0.0s
 ⠿ Volume "compose_peer0.service1.moss.com"  Created    0.0s
 ⠿ Container peer0.platform.moss.com         Started    4.7s
 ⠿ Container peer1.customer.moss.com         Started    8.3s
 ⠿ Container peer1.service1.moss.com         Started    10.4s
 ⠿ Container peer1.platform.moss.com         Started    12.7s
 ⠿ Container osn2.orderer1.moss.com          Started    15.9s
 ⠿ Container peer0.service1.moss.com         Started    9.3s
 ⠿ Container peer1.service2.moss.com         Started    7.3s
 ⠿ Container osn3.orderer1.moss.com          Started    15.2s
 ⠿ Container osn1.orderer1.moss.com          Started    13.3s
 ⠿ Container peer0.service2.moss.com         Started    5.9s
 ⠿ Container peer0.customer.moss.com         Started    9.5s
 ⠿ Container cli                             Started    9.4s
```


## 개선 필요사항
. 네트워크 환경 k8s로 변경
. CA adin 비밀번호 암호화
. CA DB MySQL로 변경